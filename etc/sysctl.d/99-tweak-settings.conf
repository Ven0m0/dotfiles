# ========================================
# System Control Tweaks
# ========================================
# Kernel parameters for performance and security optimization
# https://wiki.archlinux.org/title/Sysctl

# ========================================
# Network: Modern TCP Configuration
# ========================================
# Use Fair Queue (fq) queueing discipline for better latency
net.core.default_qdisc = fq

# Enable BBR congestion control for improved throughput
net.ipv4.tcp_congestion_control = bbr

# Enable Explicit Congestion Notification
net.ipv4.tcp_ecn = 1
net.ipv4.tcp_ecn_fallback = 1

# Enable TCP Fast Open for faster connection establishment
net.ipv4.tcp_fastopen = 3

# Enable Path MTU Discovery
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_base_mss = 1220

# Enable TCP performance features
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_delack_min = 10
net.ipv4.tcp_low_latency = 1

# ========================================
# Network Buffers
# ========================================
# Align autotune caps with core maxima for better performance

# Core buffer sizes
net.core.rmem_default = 1048576
net.core.wmem_default = 1048576
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864

# TCP buffer sizes (min, default, max)
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# UDP buffer sizes
net.core.optmem_max = 65536
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# ========================================
# Network Backlogs and Queues
# ========================================
net.core.netdev_max_backlog = 8192
net.ipv4.tcp_max_syn_backlog = 8192
net.core.somaxconn = 8192
net.ipv4.ip_local_port_range = 20000 65535

# ========================================
# Network Hardening
# ========================================
# Enable security features and sane defaults

net.ipv4.tcp_dsack = 1
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_moderate_rcvbuf = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.udp_early_demux = 1

# Disable source routing and redirects
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0

# ========================================
# TCP Connection Management
# ========================================
# TIME_WAIT / orphan controls to avoid runaway memory usage

net.ipv4.tcp_max_tw_buckets = 500000
net.ipv4.tcp_max_orphans = 65536
net.ipv4.tcp_fin_timeout = 20

# ========================================
# Neighbor Table Configuration
# ========================================
# ARP/ND cache garbage collection thresholds and scan interval

# IPv4 neighbor table
net.ipv4.neigh.default.gc_thresh1 = 256
net.ipv4.neigh.default.gc_thresh2 = 1024
net.ipv4.neigh.default.gc_thresh3 = 4096
net.ipv4.neigh.default.gc_interval = 30

# IPv6 neighbor table
net.ipv6.neigh.default.gc_thresh1 = 256
net.ipv6.neigh.default.gc_thresh2 = 1024
net.ipv6.neigh.default.gc_thresh3 = 4096
net.ipv6.neigh.default.gc_interval = 30

# ========================================
# Filesystem Limits
# ========================================
# Maximum number of file handles
fs.file-max = 2097152

# Security: disable core dumps from setuid programs
fs.suid_dumpable = 0

# Symlink and hardlink protection
fs.protected_symlinks = 0
fs.protected_hardlinks = 1

# ========================================
# Virtual Memory Management
# ========================================
# Optimized for desktop/workstation use
# Reference: https://github.com/fiftydinar/gidro-os/blob/b172d940c85cfa7a988010e2598281138674d290/files/0-system/usr/bin/memory-tweaks-gidro

# Disable zone reclaim mode for NUMA systems
vm.zone_reclaim_mode = 0

# Minimum free memory to keep available
vm.min_free_kbytes = 71680

# VFS cache pressure (lower = keep more cache)
vm.vfs_cache_pressure = 50

# Dirty page management (in bytes)
vm.dirty_bytes = 268435456
vm.dirty_background_bytes = 67108864

# Page clustering for swap (0 = no readahead)
vm.page-cluster = 0

# Swappiness (higher = more aggressive swapping)
vm.swappiness = 150

# Memory reclaim ratios
vm.anon_min_ratio = 0
vm.clean_low_ratio = 15
vm.clean_min_ratio = 1

# ========================================
# Kernel Behavior
# ========================================
# Disable NMI watchdog to save power
kernel.nmi_watchdog = 0

# Allow unprivileged user namespaces
kernel.unprivileged_userns_clone = 1

# Restrict kernel pointer exposure
kernel.kptr_restrict = 2

# Disable kexec (security)
kernel.kexec_load_disabled = 1

# Disable hung task timeout warnings
kernel.hung_task_timeout_secs = 0

# Message queue limits
kernel.msgmax = 65536
kernel.msgmnb = 65536

# Console logging level (errors and above)
kernel.printk = 3 3 3 3

# Disable core dumps entirely
kernel.core_pattern = |/bin/false

# Disable split lock mitigation for performance
kernel.split_lock_mitigate = 0
