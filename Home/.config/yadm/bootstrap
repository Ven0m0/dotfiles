#!/usr/bin/env bash
# shellcheck enable=all shell=bash source-path=SCRIPTDIR
set -euo pipefail; shopt -s nullglob globstar
export LC_ALL=C; IFS=$'\n\t'
s=${BASH_SOURCE[0]}; [[ $s != /* ]] && s=$PWD/$s; cd -P -- "${s%/*}"
has(){ command -v -- "$1" &>/dev/null; }
info(){ printf '==> %s\n' "$*"; }
warn(){ printf '==> WARNING: %s\n' "$*"; }
die(){ printf '==> ERROR: %s\n' "$*" >&2; exit 1; }
WORKTREE="$(yadm config core.worktree 2>/dev/null || printf '%s\n' "$HOME")"
REPO_DIR="$WORKTREE"
[[ -d $REPO_DIR ]] || die "Worktree not found: $REPO_DIR"
info "YADM Bootstrap starting (worktree: $REPO_DIR)"
yadm submodule update --recursive --init || warn "Submodules not initialized"
deploy_home(){
  local home_dir="${REPO_DIR}/Home"
  [[ -d $home_dir ]] || { warn "Home/ not found: $home_dir"; return 0; }
  info "Deploying Home/ → $HOME/"
  if has rsync; then
    rsync -a --delete --exclude='.git' --exclude='.gitignore' "${home_dir}/" "${HOME}/"
  else
    warn "rsync missing; falling back to cp"
    cp -a "${home_dir}/." "${HOME}/"
  fi
}
install_base_deps(){
  info "Installing base dependencies..."
  if has pacman; then
    local pac_cmd="sudo pacman"
    has paru && pac_cmd="paru"
    has yay && pac_cmd="yay"
    # Try tuckr first, fall back to stow if unavailable
    if ! $pac_cmd -Sq --needed --noconfirm git gitoxide aria2 curl zsh fd sd ripgrep bat jq zoxide starship fzf tuckr rsync konsave; then
      warn "tuckr install failed, installing stow as fallback"
      $pac_cmd -Sq --needed --noconfirm git gitoxide aria2 curl zsh fd sd ripgrep bat jq zoxide starship fzf stow rsync konsave || warn "Some packages may have failed to install"
    fi
  elif has apt-get; then
    sudo apt-get update -y
    sudo apt-get install -y git curl zsh fd-find ripgrep bat jq fzf stow rsync || warn "Some packages may have failed"
    if ! has zoxide; then
      warn "zoxide not packaged; install manually if desired"
    fi
  else
    warn "Unknown package manager; install deps manually."
  fi
}
configure_shell(){
  info "Configuring shell environment..."
  mkdir -p "${HOME}/.config" "${HOME}/bin" "${HOME}/.local/bin"
  if has zsh; then
    local zsh_path; zsh_path="$(command -v zsh)"
    if [[ ${SHELL:-} != "$zsh_path" ]]; then
      chsh -s "$zsh_path" "$USER" 2>/dev/null || warn "Could not change shell; run: chsh -s $zsh_path"
    fi
  fi
  if has starship && [[ ! -f ${HOME}/.config/starship.toml ]]; then
    info "Installing Starship nerd-font preset..."
    starship preset nerd-font-symbols -o "${HOME}/.config/starship.toml"
  fi
  if has zoxide; then
    local zshrc="${ZDOTDIR:-$HOME}/.zshrc"
    if [[ -f $zshrc ]] && ! grep -q 'zoxide init' "$zshrc" 2>/dev/null; then
      {
        printf '\n# zoxide - smarter cd command\n'
        printf 'eval "$(zoxide init --cmd cd zsh)"\n'
      } >> "$zshrc"
    fi
  fi
}
deploy_system_configs(){
  local pkg use_tuckr=true
  if has tuckr; then
    info "Using tuckr for system config deployment"
    local hooks_file="${REPO_DIR}/hooks.toml"
    for pkg in etc usr; do
      local src="${REPO_DIR}/${pkg}"
      [[ -d $src ]] || { warn "Missing dir: $src"; continue; }
      info "Linking ${pkg}/ → / (tuckr)"
      local cmd=(sudo tuckr link -d "$REPO_DIR" -t / "$pkg")
      [[ -f $hooks_file ]] && cmd+=(-H "$hooks_file")
      "${cmd[@]}" || warn "Failed to link $pkg"
    done
  elif has stow; then
    info "tuckr not found, using stow as fallback"
    for pkg in etc usr; do
      local src="${REPO_DIR}/${pkg}"
      [[ -d $src ]] || { warn "Missing dir: $src"; continue; }
      info "Linking ${pkg}/ → / (stow)"
      (cd "$REPO_DIR" && sudo stow -t / -d . "$pkg") || warn "Failed to stow $pkg"
    done
  else
    warn "Neither tuckr nor stow installed; skipping etc/usr deployment."
    warn "Install tuckr: paru -S tuckr"
    warn "  OR stow: paru -S stow"
    warn "Then run: sudo tuckr link -d $REPO_DIR -t / etc usr"
    warn "      OR: cd $REPO_DIR && sudo stow -t / etc usr"
    return 0
  fi
}
setup_alternates(){
  info "Processing yadm alternates..."
  yadm alt 2>/dev/null || warn "No alternate files to process"
}
# Import and apply the Konsave backup (best-effort, non-fatal).
apply_konsave_profile(){
  local profile_file="${REPO_DIR}/main.knsv" profile_name="main"
  if ! has konsave; then
    warn "konsave not installed; skipping KDE profile import."
    return 0
  fi
  [[ -f $profile_file ]] || { warn "Konsave profile not found: $profile_file"; return 0; }
  local profile_list="" profile_present=false
  if profile_list="$(konsave -l 2>/dev/null)"; then
    if [[ -n $profile_list ]] && grep -qF "$profile_name" <<<"$profile_list"; then
      profile_present=true
    fi
  else
    warn "konsave -l failed; will attempt to import profile if needed"
  fi
  if [[ $profile_present == false ]]; then
    info "Importing Konsave profile (${profile_name}) from ${profile_file}"
    if konsave -i "$profile_file"; then
      profile_present=true
    else
      warn "Failed to import Konsave profile from $profile_file"
      return 0
    fi
  fi
  if [[ $profile_present == true ]]; then
    konsave -a "$profile_name" || { warn "Failed to apply Konsave profile: $profile_name"; return 0; }
  fi
}
run_app_bootstraps(){
  local home_bootstrap="${HOME}/.config/yadm/bootstrap"
  [[ -x $home_bootstrap ]] || return 0
  info "Running nested bootstrap: $home_bootstrap"
  "$home_bootstrap" || warn "Nested bootstrap returned non-zero"
}
main(){
  deploy_home
  install_base_deps
  configure_shell
  deploy_system_configs
  apply_konsave_profile
  setup_alternates
  run_app_bootstraps
  info "✓ YADM Bootstrap completed."
  info "Validate /etc/fstab: sudo systemd-analyze verify /etc/fstab"
  info "System configs (needs sudo): sudo tuckr link -d $REPO_DIR -t / etc usr"
}
main "$@"
