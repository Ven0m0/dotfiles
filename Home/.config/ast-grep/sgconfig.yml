# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json
severity: warning
# ==============================================================================
# UTILITIES
# ==============================================================================
utils:
  is-console:
    kind: member_expression
    pattern: console.$METHOD
  is-shebang:
    kind: comment
    regex: '^#!/'
  in-string:
    inside:
      any: [{kind: double_quoted_string}, {kind: single_quoted_string}, {kind: raw_string}]
  in-test-or-assign:
    inside:
      any: [{kind: test_command}, {kind: arithmetic_expansion}, {kind: assignment}]
  in-loop:
    inside:
      any: [{kind: for_statement}, {kind: while_statement}]
  is-func-def:
    kind: function_definition
# ==============================================================================
# RULES (Merged & Compacted)
# ==============================================================================
rules:
  # ============================================================================
  # PYTHON — Type Safety & Performance
  # ============================================================================
  - id: py-type-hints
    language: python
    message: Add type hints (params and return)
    note: 'def fn(x: int) -> bool'
    severity: error
    rule:
      any:
        -
          pattern: 'def $FN($$$PARAMS):'
          all:
            - not: {has: {kind: type}}
            - not: {has: {kind: identifier, regex: '^__(init|new|enter|exit|del|repr|str)__$'}}
        -
          kind: parameters
          inside: {utils: is-func-def}
          has:
            kind: identifier
            all:
              - not: {follows: {kind: type}}
              - not: {regex: '^(self|cls)$}'
  - id: py-loop-performance
    language: python
    message: Optimize loop pattern
    note: 'Use comprehension, precompile regex, avoid string concat'
    severity: warning
    rule:
      any:
        - kind: augmented_assignment
          pattern: $VAR += $STR
          utils: in-loop
        - pattern: re.$METHOD($PATTERN, $$$)
          utils: in-loop
        - kind: for_statement
          pattern: |
            for $VAR in $ITER:
              $LIST.append($EXPR)
    fix: $LIST = [$EXPR for $VAR in $ITER]  # Only for append pattern
  - id: py-unsafe-patterns
    language: python
    message: Unsafe pattern detected
    note: 'Bare except, mutable default, subprocess shell=True'
    severity: error
    rule:
      any:
        - kind: except_clause
          pattern: 'except:'
        - kind: default_parameter
          has: {any: [{kind: list}, {kind: dictionary}, {kind: set}]}
        - pattern: subprocess.$METHOD($CMD, shell=True)
  - id: py-prefer-idioms
    language: python
    message: Use Python idiom
    note: 'f-string, dict.get, set membership, comprehension, Path'
    severity: info
    rule:
      any:
        - pattern: $STR.format($$$)
        - kind: if_statement
          pattern: |
            if $KEY in $DICT:
              $VAR = $DICT[$KEY]
            else:
              $VAR = $DEFAULT
        - pattern: os.path.exists($PATH)
        - kind: comparison_operator
          pattern: $VAR in $LIST
          has: {kind: list}
  - id: py-dataclass-slots
    language: python
    message: Add slots=True to dataclass (memory/speed)
    severity: info
    rule:
      kind: decorated_definition
      has: {kind: decorator, pattern: '@dataclass', not: {regex: 'slots=True'}}
  # ============================================================================
  # BASH — Critical (Must Fix)
  # ============================================================================
  - id: bash-critical-standards
    language: bash
    message: Critical bash standard violation
    note: 'Use #!/usr/bin/env bash, set -euo pipefail, no eval/expr/backticks'
    severity: error
    rule:
      any:
        - utils: is-shebang
          regex: '^#!/bin/(ba)?sh'
        - kind: command_substitution
          regex: '`.*`'
        - kind: command
          any: [{pattern: eval $$$}, {pattern: expr $$$}]
        - kind: pipeline
          pattern: ls $$$ARGS | $CMD
        - utils: is-shebang
          regex: '^#!/bin/sh'
    fix: '#!/usr/bin/env bash'  # Only for shebang
  - id: bash-set-options
    language: bash
    message: Add set -euo pipefail at script start
    severity: error
    rule:
      kind: file
      not: {has: {kind: command, pattern: set -$$$, has: {regex: '[euo].*pipefail|pipefail.*[euo]'}}}
  - id: bash-unquoted-expansion
    language: bash
    message: Quote variable/command substitution
    note: 'Prevents word splitting/globbing'
    severity: error
    rule:
      any:
        - kind: expansion
          regex: '^\$[A-Za-z_][A-Za-z0-9_]*$'
          not: {any: [{utils: in-string}, {utils: in-test-or-assign}, {inside: {any: [{kind: case_item}, {kind: for_statement}]}}]}
        - kind: command_substitution
          not: {any: [{utils: in-string}, {utils: in-test-or-assign}]}
        - kind: expansion
          regex: '^\$\{[A-Za-z_][A-Za-z0-9_]*\[@\]\}$'
          not: {utils: in-string}
  # ============================================================================
  # BASH — Style (Bashisms)
  # ============================================================================
  - id: bash-compact-syntax
    language: bash
    message: Use compact bash syntax
    note: 'fn(){ not fn() {, &>/dev/null, [[ ]], printf, :'
    severity: error
    rule:
      any:
        - kind: function_definition
          regex: '\)\s+\{'
        - kind: redirected_statement
          regex: '>\s*/dev/null\s+2>&1'
        - kind: redirect
          regex: '>\s+/dev/null'
        - kind: test_command
          regex: '^\[\s'
          not: {regex: '^\[\['}
        - kind: command
          any: [{pattern: echo -n $$$}, {pattern: /usr/bin/printf $$$}]
        - pattern: $CMD || true
    fix: |
      $CMD || :  # For || true pattern
      &>/dev/null  # For redirect pattern
  - id: bash-idiom-colon
    language: bash
    message: "Use ':' instead of 'true' (1 char, builtin)"
    severity: info
    rule:
      any:
        - pattern: $CMD || true
        - pattern: while true; do $$$BODY; done
    fix: |
      $CMD || :
      while :; do $$$BODY; done
  # ============================================================================
  # BASH — Performance (High Impact)
  # ============================================================================
  - id: bash-avoid-forks
    language: bash
    message: Avoid unnecessary fork
    note: 'Use builtin/redirect instead of cat/sed/subshell'
    severity: warning
    rule:
      any:
        - kind: pipeline
          pattern: cat $FILE | $CMD
        - pattern: sed 's/^$PREFIX//' <<< "$VAR"
        - pattern: echo "$VAR" | sed 's/^$PREFIX//'
        - kind: pipeline
          utils: in-loop
        - kind: subshell
          not: {inside: {any: [{kind: pipeline}, {kind: command_substitution}]}}
        - kind: command
          pattern: let $$$
    fix: |
      $CMD < $FILE  # For cat
      echo "${VAR#$PREFIX}"  # For sed prefix
      (( $$$ ))  # For let
  - id: bash-prefer-mapfile
    language: bash
    message: Use mapfile instead of while read (10-100x faster)
    severity: info
    rule:
      kind: while_statement
      pattern: |
        while IFS= read -r $VAR; do
          $ARRAY+=("$VAR")
        done
    fix: mapfile -t $ARRAY
  - id: bash-prefer-read-builtin
    language: bash
    message: Use read builtin instead of head
    severity: info
    rule:
      kind: pipeline
      pattern: $CMD | head -n1
    fix: $CMD | { read -r line; echo "$line"; }
  # ============================================================================
  # BASH — Modern Tools (Hints)
  # ============================================================================
  - id: bash-modern-tools
    language: bash
    message: Consider modern alternative (if installed)
    note: 'fd→find, rg→grep, sd→sed, jaq→jq, zstd→xz, aria2c→curl/wget'
    severity: hint
    rule:
      kind: command
      any:
        - pattern: find $$$ARGS -name $PATTERN
        - pattern: grep -r $$$
        - pattern: grep -R $$$
        - pattern: sed -i $$$
        - pattern: jq $$$
        - pattern: xz -$$$
        - pattern: unxz $$$
        - pattern: wget $URL
        - pattern: curl -O $URL
  - id: bash-literal-search
    language: bash
    message: Use -F for literal search (faster)
    severity: hint
    rule:
      kind: command
      any: [{pattern: grep "$PATTERN" $$$}, {pattern: rg "$PATTERN" $$$}]
      not: {has: {regex: '\s-[EFPGo]'}}
  - id: bash-parallel-jobs
    language: bash
    message: Consider parallelizing independent tasks (& and wait)
    severity: hint
    rule:
      kind: list
      pattern: |
        $CMD1
        $CMD2
        $CMD3
      not: {has: {kind: background_command}}
  # ============================================================================
  # BASH — Best Practices
  # ============================================================================
  - id: bash-local-vars
    language: bash
    message: Use local for function variables
    severity: warning
    rule:
      kind: assignment
      inside: {utils: is-func-def}
      not: {any: [{inside: {kind: declaration_command}}, {has: {kind: identifier, regex: '^[A-Z_]+$'}}]}
  - id: bash-case-optimize
    language: bash
    message: Consider if-else for 2-branch case or inline trivial case
    severity: hint
    rule:
      kind: case_statement
      any:
        - pattern: |
            case $VAR in
              $PATTERN) $CMD ;;
            esac
          not: {has: {kind: case_item, regex: '[\*\?\[]'}}
          not: {utils: in-loop}
        - pattern: |
            case $VAR in
              $PATTERN1) $CMD1 ;;
              *) $CMD2 ;;
            esac
          not: {has: {kind: case_item, regex: '^-[a-zA-Z]|--[a-z]'}}
          not: {inside: {kind: while_statement}}
  # ============================================================================
  # TYPESCRIPT/JAVASCRIPT — Critical
  # ============================================================================
  - id: ts-critical-errors
    language: typescript
    message: Critical error pattern
    note: 'console, debugger, eval, var'
    severity: error
    rule:
      any:
        - utils: is-console
        - kind: debugger_statement
        - pattern: eval($EXPR)
        - pattern: new Function($$$ARGS)
        - pattern: setTimeout($STRING, $$$)
          has: {kind: string}
        - kind: variable_declaration
          pattern: var $VAR = $INIT
    fix: ''  # Remove console/debugger
  - id: ts-unsafe-patterns
    language: typescript
    message: Unsafe pattern
    note: 'XSS risk (innerHTML), type coercion (==)'
    severity: warning
    rule:
      any:
        - pattern: innerHTML = $VAL
        - pattern: outerHTML = $VAL
        - pattern: insertAdjacentHTML($POS, $VAL)
        - pattern: document.write($VAL)
        - pattern: document.writeln($VAL)
        - kind: binary_expression
          any: [{pattern: $A == $B}, {pattern: $A != $B}]
        - kind: catch_clause
          has: {kind: statement_block, pattern: '{}'}
  - id: ts-prefer-modern
    language: typescript
    message: Use modern syntax
    note: 'const, ??, ?., ==='
    severity: info
    rule:
      any:
        - kind: lexical_declaration
          pattern: let $VAR = $INIT
          not: {any: [{inside: {kind: for_statement}}, {inside: {kind: assignment_expression, has: {field: left, pattern: $VAR}}}]}
        - kind: binary_expression
          pattern: $A || $B
        - pattern: $OBJ && $OBJ.$PROP
    fix: |
      const $VAR = $INIT  # For let
      $OBJ?.$PROP  # For && chain
  - id: ts-arrow-functions
    language: typescript
    message: Prefer arrow functions for callbacks
    severity: hint
    rule:
      kind: function_expression
      inside: {any: [{kind: arguments}, {kind: array}]}
  # ============================================================================
  # ALL — Common Issues
  # ============================================================================
  - id: todo-comments
    languages: [typescript, javascript, bash, python]
    message: Resolve TODO/FIXME/XXX/HACK comment
    severity: warning
    rule:
      kind: comment
      regex: '\b(TODO|FIXME|XXX|HACK)\b'
