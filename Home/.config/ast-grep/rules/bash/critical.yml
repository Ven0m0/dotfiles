id: bash-critical-standards
language: bash
severity: error
message: Critical bash standard violation
note: "Use #!/usr/bin/env bash, no eval/expr/backticks/ls parsing, no /bin/sh"
rule:
  any:
    - kind: comment
      regex: "^#!/bin/(ba)?sh"
    - kind: command_substitution
      regex: "`.*`"
    - kind: command
      pattern: eval $$$
    - kind: command
      pattern: expr $$$
    - kind: pipeline
      pattern: ls $$$ARGS | $CMD
    - kind: comment
      regex: "^#!/bin/sh"
fix: "#!/usr/bin/env bash"
---
id: bash-set-options
language: bash
severity: error
message: Add 'set -euo pipefail' at script start
note: "Exit on error, undefined vars, pipe failures"
rule:
  kind: file
  not:
    has:
      kind: command
      pattern: set -$$$
      has:
        regex: "[euo].*pipefail|pipefail.*[euo]"
fix: |
  #!/usr/bin/env bash
  set -euo pipefail
---
id: bash-unquoted-expansion
language: bash
severity: error
message: Quote variable/command substitution to prevent word splitting
note: 'Use "$var" not $var; Use "$(cmd)" not $(cmd)'
rule:
  any:
    - kind: expansion
      regex: ^\$[A-Za-z_][A-Za-z0-9_]*$
      not:
        any:
          - inside:
              any:
                - kind: double_quoted_string
                - kind: single_quoted_string
                - kind: raw_string
          - inside:
              any:
                - kind: test_command
                - kind: arithmetic_expansion
                - kind: assignment
          - inside:
              any:
                - kind: case_item
                - kind: for_statement
    - kind: command_substitution
      not:
        any:
          - inside:
              any:
                - kind: double_quoted_string
                - kind: single_quoted_string
                - kind: raw_string
          - inside:
              any:
                - kind: test_command
                - kind: arithmetic_expansion
                - kind: assignment
    - kind: expansion
      regex: '^\$\{[A-Za-z_][A-Za-z0-9_]*\[@\]\}$'
      not:
        inside:
          any:
            - kind: double_quoted_string
            - kind: single_quoted_string
            - kind: raw_string
