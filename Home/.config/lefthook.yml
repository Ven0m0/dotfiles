skip_output: [meta, execution]
output: [summary, skips]
colors: true
no_tty: false

pre-commit:
  parallel: true
  commands:
    auto-stage:
      run: gix add -A 2>/dev/null || git add -A
    shell-format:
      glob: "*.{sh,bash,zsh}"
      run: |
        shellcheck -x -a -s bash -f diff {staged_files} | patch -Np1 || :
        shellharden --replace {staged_files} || :
        shfmt -w -ln bash -i 2 -s -bn {staged_files} || :
      stage_fixed: true
    yaml-format:
      glob: "*.{yml,yaml}"
      run: |
        yamlfmt {staged_files} || :
        yamllint -f parsable {staged_files} || :
      stage_fixed: true
    json-validate:
      glob: "*.{json,jsonc,json5}"
      run: |
        for f in {staged_files}; do
          jaq -e . "$f" &>/dev/null || jq -e . "$f" || { printf "Invalid: %s\n" "$f" >&2; exit 1; }
        done
    markdown-format:
      glob: "*.md"
      run: |
        if command -v mado &>/dev/null; then
          mado check --fix {staged_files} || :
        elif command -v rumdl &>/dev/null; then
          rumdl check --fix {staged_files} || :
        elif command -v markdownlint-cli2 &>/dev/null; then
          markdownlint-cli2 --fix {staged_files} || :
        fi
      stage_fixed: true
    js-format:
      glob: "*.{js,ts,cjs,mjs,d.cts,d.mts,jsx,tsx,json,jsonc}"
      run: |
        if command -v biome &>/dev/null; then
          BIOME_CONFIG_PATH="${HOME}/biome.json" biome check --write --unsafe --skip-parse-errors {staged_files} || :
        else
          bunx --bun @biomejs/biome check --write --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files} || :
        fi
      stage_fixed: true
    prettier-format:
      glob: "*.{mjs,cjs,scss,html}"
      run: prettier -w --ignore-unknown {staged_files} || :
      stage_fixed: true
    eslint-fix:
      glob: "*.{js,jsx,ts,tsx,mjs,cjs}"
      run: eslint --fix -q {staged_files} || :
      stage_fixed: true
    trim-trailing:
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2?|ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] && sed -i 's/[ \t]*$//' "$f"
        done
      stage_fixed: true
    strip-unicode:
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2?|ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] && sed -i 's/\xE2\x80\x8B\|\xE2\x80\x8C\|\xE2\x80\x8D\|\xE2\x80\xAF\|\xC2\xAD\|\xEF\xBB\xBF//g' "$f"
        done
      stage_fixed: true
    normalize-eol:
      glob: "*.{sh,bash,zsh,yml,yaml,json,md,txt,toml,ini,conf,cfg,js,ts,tsx,jsx,css,html}"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] && { dos2unix -q "$f" 2>/dev/null || sed -i 's/\r$//' "$f"; }
        done
      stage_fixed: true
    ensure-shebang:
      glob: "*.{sh,bash}"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] && rg -q '^#!' "$f" || {
            printf '#!/usr/bin/env bash\n%s' "$(<"$f")" > "$f.tmp" && mv "$f.tmp" "$f"
          }
        done
      stage_fixed: true
    check-filesize:
      run: |
        max_kb=5120
        for f in {staged_files}; do
          [[ -f "$f" ]] || continue
          size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo 0)
          (( size > max_kb * 1024 )) && printf "Large: %s (%dKB)\n" "$f" "$((size/1024))" >&2
        done || :
    detect-secrets:
      run: |
        rg -iNn \
          -e '(password|passwd|api[_-]?key|secret[_-]?key|access[_-]?token|auth[_-]?token|bearer|client[_-]?secret|private[_-]?key)\s*[:=]\s*["\047][^"\047]{20,}' \
          -e 'AKIA[0-9A-Z]{16}' \
          -e 'ghp_[0-9a-zA-Z]{36}' \
          -e 'glpat-[0-9a-zA-Z_-]{20,}' \
          -e 'xox[baprs]-\d{10,13}-\d{10,13}-[0-9a-zA-Z]{24,}' \
          {staged_files} && { printf "Secrets detected\n" >&2; exit 1; } || :
    check-debug:
      glob: "*.{sh,bash,js,jsx,ts,tsx,py,rb,go}"
      run: |
        rg -iN \
          -e '\bconsole\.(log|debug|info|warn|error)\(' \
          -e '\bdebugger\b' -e '\bbinding\.pry\b' -e '\bset -x\b' -e '\bprint\s*\(.*DEBUG' \
          {staged_files} && { printf "Debug code\n" >&2; exit 1; } || :
    no-merge-conflicts:
      run: rg -FN '^(<{7}|={7}|>{7})' {staged_files} && { printf "Merge conflicts\n" >&2; exit 1; } || :
    check-todos:
      run: |
        count=$(rg -ic '\b(TODO|FIXME|XXX|HACK)\b' {staged_files} 2>/dev/null | awk -F: '{s+=$2}END{print s+0}')
        (( count > 0 )) && printf "%d TODO/FIXME\n" "$count" >&2 || :

commit-msg:
  commands:
    conventional-commits:
      run: |
        msg=$(<{1})
        rg -q '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}' <<< "$msg" || {
          printf "Use Conventional Commits:\n  type(scope?): subject\n\nTypes: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert\n" >&2
          exit 1
        }
    msg-length:
      run: |
        subject=$(head -n1 {1})
        (( ${#subject} > 72 )) && { printf "Subject >72 chars (%d)\n" "${#subject}" >&2; exit 1; } || :
    no-wip:
      run: rg -qi '\b(wip|todo|fixme|hack)\b' {1} && { printf "Remove WIP\n" >&2; exit 1; } || :

pre-push:
  parallel: true
  commands:
    run-tests:
      run: |
        [[ -f Makefile ]] && { make test &>/dev/null; exit 0; }
        [[ -f package.json ]] && { bun test &>/dev/null || npm test &>/dev/null; exit 0; }
        [[ -f Cargo.toml ]] && { cargo test -q &>/dev/null; exit 0; }
        [[ -f go.mod ]] && { go test ./... &>/dev/null; exit 0; }
        exit 0
    branch-check:
      run: |
        branch=$(gix rev parse --abbrev-ref HEAD 2>/dev/null || git rev-parse --abbrev-ref HEAD)
        rg -q '^(main|master|production)$' <<< "$branch" && {
          printf "Direct push to %s blocked\n" "$branch" >&2; exit 1
        }
        rg -q '^(main|master|develop|staging|release/.+|hotfix/.+|feature/.+|(bug)?fix/.+)$' <<< "$branch" || {
          printf "Use git-flow: feature/*, fix/*, release/*, hotfix/*\n" >&2
        }
        exit 0
    audit-deps:
      run: |
        [[ -f package.json ]] && { bun audit || npm audit --production --audit-level=high; } || :
        [[ -f Cargo.toml ]] && cargo audit || :
        exit 0

post-merge:
  commands:
    update-deps:
      run: |
        if [[ -f bun.lockb ]]; then
          bun install --frozen-lockfile &>/dev/null
        elif [[ -f package-lock.json ]]; then
          bun install --frozen-lockfile &>/dev/null || npm ci --prefer-offline &>/dev/null
        fi
        [[ -f Cargo.lock ]] && cargo fetch &>/dev/null
        exit 0
    clean-artifacts:
      run: rm -rf node_modules/.cache target/debug .pytest_cache __pycache__ .next .turbo dist build || :
post-checkout:
  commands:
    update-submodules:
      run: git submodule update --init --recursive &>/dev/null || :
    notify-deps:
      run: |
        changed=$(gix diff HEAD@{1} HEAD --name-only 2>/dev/null || git diff HEAD@{1} HEAD --name-only)
        rg -q '^(package\.json|bun\.lockb|.*lock\.json)$' <<< "$changed" && {
          printf "Dependencies changed. Run: bun install\n" >&2
        } || :

prepare-commit-msg:
  commands:
    insert-ticket:
      run: |
        branch=$(gix rev parse --abbrev-ref HEAD 2>/dev/null || git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(feature|bugfix|hotfix|fix)/([A-Z]+-[0-9]+) ]] && {
          ticket="${BASH_REMATCH[2]}"
          rg -q "$ticket" {1} || sed -i "1s/^/$ticket: /" {1}
        } || :
