skip_output: [meta, execution]
output: [summary, skips]
colors: true
no_tty: false
min_version: 1.5.0
pre-commit:
  parallel: true
  commands:
    shell-format:
      priority: 1
      glob: '*.{sh,bash,zsh}'
      run: |
        shfmt -w -i 2 -bn -ci -sr {staged_files} || :
        shellcheck -S style {staged_files} || :
        shellharden --replace {staged_files} || :
        git add {staged_files}
      stage_fixed: true
      fail_text: 'Shell formatting failed'
    yaml-format:
      priority: 2
      glob: '*.{yml,yaml}'
      run: |
        yamlfmt {staged_files} && yamllint -s {staged_files}
        git add {staged_files}
      stage_fixed: true
      fail_text: 'YAML formatting/linting failed'
    json-validate:
      priority: 3
      glob: '*.{json,jsonc,json5}'
      run: |
        for f in {staged_files}; do
          jaq -e . "$f" &>/dev/null || jq -e . "$f" || { printf "Invalid: %s\n" "$f" >&2; exit 1; }
        done
      fail_text: 'JSON validation failed'
    markdown-format:
      priority: 4
      glob: '*.md'
      run: |
        if command -v mdformat &>/dev/null; then
          mdformat {staged_files} || :
        elif command -v markdownlint-cli2 &>/dev/null; then
          markdownlint-cli2 --fix {staged_files} || :
        fi
        git add {staged_files}
      stage_fixed: true
      fail_text: 'Markdown formatting failed'
    biome:
      priority: 5
      glob: '*.{js,ts,cjs,mjs,d. cts,d.mts,jsx,tsx,json,jsonc}'
      run: |
        cfg="${HOME}/.config/biome.json"
        [[ -r "$cfg" ]] || cfg="${HOME}/biome.json"
        if command -v biome &>/dev/null; then
          BIOME_CONFIG_PATH="$cfg" biome check --write --skip-parse-errors --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files}
        fi || :
        git add {staged_files}
      stage_fixed: true
      fail_text: 'Biome failed'
    prettier-format:
      priority: 6
      glob: '*.{mjs,cjs,scss,html}'
      run: 'prettier -w --ignore-unknown {staged_files} || :'
      stage_fixed: true
      fail_text: 'Prettier formatting failed'
    eslint-fix:
      priority: 7
      glob: '*.{js,jsx,ts,tsx,mjs,cjs}'
      run: 'eslint --fix -q {staged_files} || :'
      stage_fixed: true
      fail_text: 'ESLint fixes failed'
    normalize-whitespace:
      priority: 8
      glob: '*'
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2? |ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        if command -v sd &>/dev/null; then
          sd '[ \t]+$' '' {staged_files}
          sd '\xE2\x80\x8B|\xE2\x80\x8C|\xE2\x80\x8D|\xE2\x80\xAF|\xC2\xAD|\xEF\xBB\xBF' '' {staged_files}
          sd '^\xEF\xBB\xBF' '' {staged_files}
        else
          sed -i 's/[ \t]*$//; s/\xE2\x80\x8B\|\xE2\x80\x8C\|\xE2\x80\x8D\|\xE2\x80\xAF\|\xC2\xAD\|\xEF\xBB\xBF//g; 1s/^\xEF\xBB\xBF//' {staged_files}
        fi
      stage_fixed: true
      fail_text: 'Whitespace normalization failed'
    normalize-eol:
      priority: 9
      glob: '*.{sh,bash,zsh,yml,yaml,json,md,txt,toml,ini,conf,cfg,js,ts,tsx,jsx,css,html}'
      run: |
        if command -v dos2unix &>/dev/null; then
          dos2unix -q {staged_files} 2>/dev/null || :
        else
          sed -i 's/\r$//' {staged_files}
        fi
      stage_fixed: true
      fail_text: 'Line ending normalization failed'
    check-shebangs:
      priority: 10
      glob: '*.{sh,bash}'
      run: |
        for f in {staged_files}; do
          [[ !  -f "$f" ]] && continue
          if [[ -x "$f" ]]; then
            grep -q '^#!' "$f" || { printf "Exec missing shebang: %s\n" "$f" >&2; exit 1; }
          else
            grep -q '^#!' "$f" || printf '#!/usr/bin/env bash\n%s' "$(<"$f")" > "$f"
          fi
        done
      stage_fixed: true
      fail_text: 'Shebang validation failed'
    check-filesize:
      priority: 11
      run: |
        for f in {staged_files}; do
          [[ ! -f "$f" ]] && continue
          size=$(wc -c < "$f")
          (( size > 5242880 )) && { printf "File too large: %s (%dMB)\n" "$f" "$((size/1048576))" >&2; exit 1; }
        done || :
      fail_text: 'Large files detected (>5MB)'
    check-case-conflict:
      priority: 12
      run: |
        sort -f <<< "{staged_files}" | uniq -di | head -n1 | {
          read -r conflict
          [[ -n "$conflict" ]] && { printf "Case conflict: %s\n" "$conflict" >&2; exit 1; }
        } || :
      fail_text: 'Case-insensitive filename conflict'
    check-symlinks:
      priority: 13
      run: |
        for f in {staged_files}; do
          [[ -L "$f" && ! -e "$f" ]] && { printf "Broken symlink: %s\n" "$f" >&2; exit 1; }
        done || :
      fail_text: 'Broken symlinks detected'
    end-of-file-fixer:
      priority: 14
      glob: '*'
      exclude: "\\.(png|jpe? g|gif|webp|ico|svg|woff2?|ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" && -s "$f" && -n $(tail -c1 "$f") ]] && printf '\n' >> "$f"
        done
      stage_fixed: true
      fail_text: 'End-of-file newline fix failed'
    detect-secrets:
      priority: 15
      run: |
        if command -v rg &>/dev/null; then
          rg -iNn \
            -e 'AKIA[0-9A-Z]{16}' \
            -e 'ghp_[0-9a-zA-Z]{36}' \
            -e 'glpat-[0-9a-zA-Z_-]{20,}' \
            -e 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[0-9a-zA-Z]{24,}' \
            -e '-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----' \
            -e '[A-Za-z0-9+/]{40,}={0,2}' \
            -e '(password|passwd|api[_-]?key|secret[_-]?key|access[_-]?token|auth[_-]?token|bearer|client[_-]? secret|private[_-]? key)[[:space:]]*[:=][[:space:]]*["\047][^"\047]{20,}' \
            {staged_files} && { printf "Secrets detected\n" >&2; exit 1; }
        fi || :
      fail_text: 'Potential secrets detected!'
    check-debug:
      priority: 16
      glob: '*.{sh,bash,js,jsx,ts,tsx,py,rb,go}'
      run: |
        if command -v rg &>/dev/null; then
          rg -iNn -e '\bconsole\.(log|debug|info|warn|error)\(' -e '\bdebugger\b' -e '\bset -x\b' {staged_files} && { printf "Debug code\n" >&2; exit 1; }
        fi || :
      fail_text: 'Debug code found!'
    no-merge-conflicts:
      priority: 17
      run: |
        if command -v rg &>/dev/null; then
          rg -FN '^(<{7}|={7}|>{7})' {staged_files} && { printf "Merge conflicts\n" >&2; exit 1; }
        fi || :
      fail_text: 'Merge conflict markers found!'
    actionlint:
      priority: 18
      glob: '. github/workflows/*.{yml,yaml}'
      run: 'actionlint {staged_files} || :'
      fail_text: 'GHA workflow linting failed'
    zizmor:
      priority: 19
      glob: '. github/workflows/*.{yml,yaml}'
      run: 'zizmor --format plain {staged_files} || :'
      fail_text: 'GHA security check failed'
    no-commit-to-branch:
      priority: 20
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
        [[ "$branch" =~ ^(main|master)$ ]] && { printf "Direct commits to %s blocked\n" "$branch" >&2; exit 1; }
      fail_text: 'Cannot commit to protected branches'
commit-msg:
  commands:
    conventional-commits:
      priority: 1
      run: |
        grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}' {1} || {
          printf "Use Conventional Commits:\n  type(scope? ): subject\n" >&2; exit 1
        }
      fail_text: 'Must follow Conventional Commits'
    msg-length:
      priority: 2
      run: |
        subject=$(head -n1 {1})
        (( ${#subject} > 72 )) && { printf "Subject >72 chars (%d)\n" "${#subject}" >&2; exit 1; } || :
      fail_text: 'Subject line too long'
    no-wip:
      priority: 3
      run: |
        grep -qEi '\b(wip|todo|fixme|hack)\b' {1} && { printf "Remove WIP\n" >&2; exit 1; } || :
      fail_text: 'WIP/TODO in message'
pre-push:
  parallel: true
  commands:
    run-tests:
      priority: 1
      run: |
        [[ -f Makefile ]] && { make test &>/dev/null; exit 0; }
        [[ -f package. json ]] && { bun test || npm test &>/dev/null; exit 0; }
        [[ -f Cargo.toml ]] && { cargo test -q &>/dev/null; exit 0; }
        exit 0
      fail_text: 'Test suite failed'
    branch-check:
      priority: 2
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(main|master|production)$ ]] && { printf "Direct push to %s blocked\n" "$branch" >&2; exit 1; }
        [[ "$branch" =~ ^(develop|staging|release/. +|hotfix/.+|feature/.+|(bug)? fix/.+|beta|alpha|next)$ ]] || {
          printf "Use git-flow: feature/*, fix/*, release/*, hotfix/*\n" >&2
        }; exit 0
      fail_text: 'Branch naming violation'
    audit-deps:
      priority: 3
      run: |
        [[ -f package.json ]] && { bun audit || npm audit --production --audit-level=high; } || :
        [[ -f Cargo.toml ]] && cargo audit || :
        exit 0
      fail_text: 'Dependency audit failed'
post-merge:
  commands:
    update-deps:
      priority: 1
      run: |
        [[ -f bun.lockb || -f package-lock.json ]] && bun install --frozen-lockfile --production 2>/dev/null || :
        [[ -f Cargo.lock ]] && cargo fetch &>/dev/null || :
        exit 0
      fail_text: 'Dependency update failed'
    clean-artifacts:
      priority: 2
      run: 'rm -rf node_modules/. cache target/debug . pytest_cache __pycache__ .next . turbo dist build || :'
      fail_text: 'Artifact cleanup failed'
post-checkout:
  commands:
    update-submodules:
      priority: 1
      run: 'git submodule update --init --recursive &>/dev/null || :'
      fail_text: 'Submodule update failed'
    notify-deps:
      priority: 2
      run: |
        changed=$(git diff HEAD@{1} HEAD --name-only)
        grep -qE '^(package\. json|bun\.lockb|.*lock\. json)$' <<< "$changed" && {
          printf "Dependencies changed.  Run: bun install\n" >&2
        } || :
      fail_text: 'Dependency check failed'
prepare-commit-msg:
  commands:
    insert-ticket:
      priority: 1
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(feature|bugfix|hotfix|fix)/([A-Z]+-[0-9]+) ]] && {
          ticket="${BASH_REMATCH[2]}"
          grep -qF "$ticket" {1} || sed -i "1s/^/$ticket: /" {1}
        } || :
      fail_text: 'Ticket insertion failed'
