skip_output: [meta, execution]
output: [summary, skips]
colors: true
no_tty: false
min_version: 1.5.0
pre-commit:
  parallel: true
  commands:
    shell-format:
      priority: 1
      glob: "*.{sh,bash,zsh}"
      run: |
        shfmt -w -i 2 -bn -ci -sr {staged_files}
        shellcheck -S style {staged_files}
        shellharden --replace {staged_files}
        git add {staged_files}
      stage_fixed: true
      fail_text: "Shell format failed"
    yaml-lint:
      priority: 2
      glob: "*.{yml,yaml}"
      run: |
        yamlfmt {staged_files} && yamllint -s {staged_files}
        git add {staged_files}
      stage_fixed: true
      fail_text: "YAML lint failed"
    json-validate:
      priority: 3
      glob: "*.{json,jsonc,json5}"
      run: |
        for f in {staged_files}; do
          jaq -e . "$f" &>/dev/null || jq -e . "$f" || { printf "Invalid: %s\n" "$f" >&2; exit 1; }
        done
      fail_text: "JSON invalid"
    biome:
      priority: 4
      glob: "*.{js,ts,cjs,mjs,d.cts,d.mts,jsx,tsx,json,jsonc}"
      run: |
        cfg="${HOME}/.config/biome.json"
        [[ -r "$cfg" ]] || cfg="${HOME}/biome.json"
        BIOME_CONFIG_PATH="$cfg" biome check --write --skip-parse-errors --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files} || :
        git add {staged_files}
      stage_fixed: true
      fail_text: "Biome failed"
    normalize:
      priority: 5
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2?|ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        if command -v sd &>/dev/null; then
          sd '[ \t]+$' '' {staged_files}
          sd '\xE2\x80\x8B|\xE2\x80\x8C|\xE2\x80\x8D|\xE2\x80\xAF|\xC2\xAD|\xEF\xBB\xBF' '' {staged_files}
          sd '^\xEF\xBB\xBF' '' {staged_files}
        else
          sed -i 's/[ \t]*$//; s/\xE2\x80\x8B\|\xE2\x80\x8C\|\xE2\x80\x8D\|\xE2\x80\xAF\|\xC2\xAD\|\xEF\xBB\xBF//g; 1s/^\xEF\xBB\xBF//' {staged_files}
        fi
        command -v dos2unix &>/dev/null && dos2unix -q {staged_files} 2>/dev/null || sed -i 's/\r$//' {staged_files}
      stage_fixed: true
      fail_text: "Normalize failed"
    security:
      priority: 6
      run: |
        command -v rg &>/dev/null || exit 0
        rg -iNn \
          -e 'AKIA[0-9A-Z]{16}' \
          -e 'ghp_[0-9a-zA-Z]{36}' \
          -e 'glpat-[0-9a-zA-Z_-]{20,}' \
          -e 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[0-9a-zA-Z]{24,}' \
          -e '-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----' \
          -e '\bconsole\.(log|debug|info|warn|error)\(' \
          -e '\bdebugger\b' \
          -e '\bset -x\b' \
          -e '^(<{7}|={7}|>{7})' \
          {staged_files} && { printf "Security/debug code detected\n" >&2; exit 1; } || :
      fail_text: "Security check failed!"
    gha-lint:
      priority: 7
      glob: ".github/workflows/*.{yml,yaml}"
      run: |
        actionlint {staged_files} || :
        command -v zizmor &>/dev/null && zizmor --format plain {staged_files} || :
      fail_text: "GHA lint failed"
    branch-protect:
      priority: 8
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
        [[ "$branch" =~ ^(main|master)$ ]] && { printf "Direct commits to %s blocked\n" "$branch" >&2; exit 1; } || :
      fail_text: "Protected branch"
commit-msg:
  commands:
    conventional:
      priority: 1
      run: |
        grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}' {1} || {
          printf "Use Conventional Commits: type(scope?): subject\n" >&2; exit 1
        }
        subject=$(head -n1 {1})
        (( ${#subject} > 72 )) && { printf "Subject >72 chars (%d)\n" "${#subject}" >&2; exit 1; } || :
        grep -qEi '\b(wip|todo|fixme|hack)\b' {1} && { printf "Remove WIP/TODO\n" >&2; exit 1; } || :
      fail_text: "Commit format invalid"
pre-push:
  parallel: true
  commands:
    test:
      priority: 1
      run: |
        [[ -f Makefile ]] && { make test &>/dev/null; exit 0; }
        [[ -f package.json ]] && { bun test || npm test &>/dev/null; exit 0; }
        [[ -f Cargo.toml ]] && { cargo test -q &>/dev/null; exit 0; }
        exit 0
      fail_text: "Tests failed"
    branch:
      priority: 2
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(main|master|production)$ ]] && { printf "Direct push to %s blocked\n" "$branch" >&2; exit 1; }
        [[ "$branch" =~ ^(develop|staging|release/.+|hotfix/.+|feature/.+|(bug)?fix/.+|beta|alpha|next)$ ]] || {
          printf "Use git-flow: feature/*, fix/*, release/*, hotfix/*\n" >&2
        }; exit 0
      fail_text: "Branch naming violation"
    audit:
      priority: 3
      run: |
        [[ -f package.json ]] && { bun audit || npm audit --production --audit-level=high; } || :
        [[ -f Cargo.toml ]] && cargo audit || :
        exit 0
      fail_text: "Audit failed"
post-merge:
  commands:
    deps:
      priority: 1
      run: |
        [[ -f bun.lockb || -f package-lock.json ]] && bun install --frozen-lockfile --production 2>/dev/null || :
        [[ -f Cargo.lock ]] && cargo fetch &>/dev/null || :
        exit 0
      fail_text: "Deps update failed"
post-checkout:
  commands:
    submodules:
      priority: 1
      run: "git submodule update --init --recursive &>/dev/null || :"
      fail_text: "Submodule update failed"
    notify:
      priority: 2
      run: |
        changed=$(git diff HEAD@{1} HEAD --name-only)
        grep -qE '^(package.json|bun\.lockb|.*lock\.json)$' <<< "$changed" && {
          printf "Dependencies changed. Run: bun install\n" >&2
        } || :
      fail_text: "Dep check failed"
prepare-commit-msg:
  commands:
    ticket:
      priority: 1
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(feature|bugfix|hotfix|fix)/([A-Z]+-[0-9]+) ]] && {
          ticket="${BASH_REMATCH[2]}"
          grep -qF "$ticket" {1} || sed -i "1s/^/$ticket: /" {1}
        } || :
      fail_text: "Ticket insert failed"
