assert_lefthook_installed: true
skip_lfs:  true
skip_output:  [meta, execution]
output:  [summary, skips]
colors: true
no_tty: false
min_version: 1.5.0

pre-commit:
  parallel: true
  commands:
    shell-format:
      priority: 1
      glob: "*.{sh,bash,zsh}"
      run: |
        command -v shfmt &>/dev/null || { printf "shfmt not installed, skipping format\n" >&2; exit 0; }
        command -v shellcheck &>/dev/null || { printf "shellcheck not installed, skipping lint\n" >&2; exit 0; }
        shfmt -w -i 2 -bn -ci -sr {staged_files}
        shellcheck -S style {staged_files}
        command -v shellharden &>/dev/null && shellharden --replace {staged_files} || : 
        git add {staged_files}
      stage_fixed: true
      fail_text: "Shell format failed"

    yaml-lint:
      priority: 2
      glob: "*.{yml,yaml}"
      run: |
        command -v yamlfmt &>/dev/null || { printf "yamlfmt not installed, skipping format\n" >&2; exit 0; }
        command -v yamllint &>/dev/null || { printf "yamllint not installed, skipping lint\n" >&2; exit 0; }
        yamlfmt {staged_files} && yamllint -s {staged_files}
        git add {staged_files}
      stage_fixed: true
      fail_text: "YAML lint failed"

    toml-lint: 
      priority: 3
      glob: "*.toml"
      run: |
        command -v taplo &>/dev/null || { printf "taplo not installed, skipping\n" >&2; exit 0; }
        taplo format {staged_files}
        taplo lint {staged_files}
        git add {staged_files}
      stage_fixed: true
      fail_text: "TOML lint failed"

    json-validate:
      priority: 4
      glob: "*.{json,jsonc,json5}"
      run: |
        if command -v jaq &>/dev/null; then
          jcmd=jaq
        elif command -v jq &>/dev/null; then
          jcmd=jq
        else
          printf "jaq/jq not installed, skipping validation\n" >&2
          exit 0
        fi
        for f in {staged_files}; do
          "$jcmd" -e .  "$f" &>/dev/null || { printf "Invalid:  %s\n" "$f" >&2; exit 1; }
        done
      fail_text: "JSON invalid"

    aglint:
      priority: 5
      glob: "*.txt"
      run: |
        command -v bunx &>/dev/null || { printf "bun not installed, skipping AGLint\n" >&2; exit 0; }
        [[ -f .aglintrc.yml ]] || { printf ". aglintrc.yml not found, skipping AGLint\n" >&2; exit 0; }
        bunx @adguard/aglint {staged_files}
      fail_text: "AGLint validation failed"

    biome:
      priority: 6
      glob: "*.{js,ts,cjs,mjs,d.cts,d.mts,jsx,tsx,json,jsonc}"
      run: bunx @biomejs/biome check --write --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files}
      stage_fixed:  true
      fail_text: "Biome failed"

    markdown-lint:
      priority: 7
      glob: "*.{md,markdown}"
      run: bunx markdownlint-cli2 --fix {staged_files}
      stage_fixed: true
      fail_text: "Markdown lint failed"

    normalize: 
      priority: 8
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2? |ttf|eot|otf|mp[34]|webm|ogg|wav|flac|pdf|zip|tar|gz|xz|zst|bz2|7z|rar)$"
      run: |
        for f in {staged_files}; do
          sed -i. bak 's/[[:space:]]*$//; s/\xE2\x80\x8B//g; s/\xE2\x80\x8C//g; s/\xE2\x80\x8D//g; s/\xE2\x80\xAF//g; s/\xC2\xAD//g; s/\xEF\xBB\xBF//g; s/\r$//' "$f"
          rm -f "${f}.bak"
        done
        command -v dos2unix &>/dev/null && dos2unix -q {staged_files} 2>/dev/null || : 
        git add {staged_files}
      stage_fixed: true
      fail_text: "Normalize failed"

    gha-lint:
      priority: 9
      glob: ". github/workflows/*.{yml,yaml}"
      run:  |
        command -v actionlint &>/dev/null || { printf "actionlint not installed, skipping\n" >&2; exit 0; }
        actionlint {staged_files}
      fail_text: "GHA lint failed"

post-merge:
  commands:
    deps:
      priority: 1
      run: |
        [[ -f bun.lockb || -f package-lock.json ]] && bun install --frozen-lockfile --production 2>/dev/null || : 
        [[ -f Cargo. lock ]] && cargo fetch &>/dev/null || :
        exit 0
      fail_text: "Deps update failed"

post-checkout:
  commands: 
    submodules:
      priority: 1
      run: "git submodule update --init --recursive &>/dev/null || :"
      fail_text:  "Submodule update failed"

    notify:
      priority: 2
      run: |
        changed=$(git diff HEAD@{1} HEAD --name-only)
        grep -qE '^(package. json|bun\. lockb|.*lock\. json)$' <<< "$changed" && {
          printf "Dependencies changed.  Run: bun install\n" >&2
        } || :
      fail_text: "Dep check failed"

prepare-commit-msg:
  commands:
    ticket:
      priority: 1
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(feature|bugfix|hotfix|fix)/([A-Z]+-[0-9]+) ]] && {
          ticket="${BASH_REMATCH[2]}"
          grep -qF "$ticket" {1} || sed -i. bak "1s/^/$ticket: /" {1} && rm -f {1}.bak
        } || :
      fail_text: "Ticket insert failed"
