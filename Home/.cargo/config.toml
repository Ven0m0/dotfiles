[unstable]
unstable-options = true
mtime-on-use = true
avoid-dev-deps = true
git = true
gitoxide = true
checksum-freshness = true
cargo-lints = true
trim-paths = true
no-embed-metadata = true
build-std = ["core", "alloc", "std"]
gc = true
panic-abort-tests = true
script = true

[alias]
b = "build"
i = "install"
rr = "run --release"
insta = "+nightly -Z unstable-options -Z mtime-on-use -Z git -Z gitoxide -Z build-dir-new-layout -Z avoid-dev-deps -Z no-embed-metadata install -f --bins --ignore-rust-version -q"
builda = "+nightly -Z unstable-options -Z mtime-on-use -Z git -Z gitoxide -Z build-dir-new-layout -Z avoid-dev-deps -Z no-embed-metadata build --bins --lib -r -q"
installgit = "+nightly -Z unstable-options -Z mtime-on-use -Z git -Z gitoxide -Z build-dir-new-layout -Z avoid-dev-deps -Z no-embed-metadata install -f --bins -q --git"

[rust]
jemalloc = true
lto = 'fat'
optimize = true
strip = true
validate-mir-opts = 3
codegen-units = 1
codegen-units-std = 1
debuginfo-level-std = 0
debug = false
frame-pointers = false
codegen-backends = ['llvm']

[llvm]
cflags = "-march=native"
cxxflags = "-march=native"
ccache = 'ccache'
libzstd = true
optimize = true
polly = true
clang = true

[build]
rustc-wrapper = "sccache"
incremental = false
#target = ["x86_64-unknown-linux-gnu"]
compiler-docs = false
optimized-compiler-builtins = true
ccache = true

# https://doc.rust-lang.org/cargo/reference/environment-variables.html
[env]
RUSTC_BOOTSTRAP = { value = "1", force = true }
RUST_PANIC_STRATEGY = { value = "abort", force = true }
CARGO_CACHE_RUSTC_INFO = { value = "1", force = true }
RUSTC_ICE = "0"
CARGO_LOG = "off"
RUSTDOC_LOG = "off"
RUSTC_LOG = "off"
MALLOC_CONF = { value = "metadata_thp:auto,tcache:true,background_thread:true,percpu_arena:percpu", force = true }
_RJEM_MALLOC_CONF = { value = "metadata_thp:auto,tcache:true,background_thread:true,percpu_arena:percpu", force = true }
MIMALLOC_ALLOW_LARGE_OS_PAGES = "1"
ZSTD_NBTHREADS = "0"
RUST_LIB_BACKTRACE = "0"
#RUST_BACKTRACE = "1"
CMAKE_BUILD_TYPE = "Release"

[cache]
auto-clean-frequency = "7 days"

[cache.global-clean]
# Anything older than this duration will be deleted in the source cache.
max-src-age = "1 month"
# Anything older than this duration will be deleted in the compressed crate cache.
max-crate-age = "3 months"
# Any index older than this duration will be deleted from the index cache.
max-index-age = "3 months"
# Any git checkout older than this duration will be deleted from the checkout cache.
max-git-co-age = "1 month"
# Any git clone older than this duration will be deleted from the git cache.
max-git-db-age = "3 months"

[http]
debug = false
ssl-version.max = "tlsv1.3"
ssl-version.min = "tlsv1.2"
timeout = 30
check-revoke = false
multiplexing = true

[net]
git-fetch-with-cli = true
retry = 3
offline = false

[registries.crates-io]
protocol = "sparse"

[resolver]
incompatible-rust-versions = "allow"

[profile.release]
opt-level = 3
codegen-units = 1
lto = "fat"
panic = "abort"
strip = "symbols"
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
rpath = false

[target.x86_64-unknown-linux-gnu]
linker = "clang"
ar = 'llvm-ar'
ranlib = 'llvm-ranlib'
rustflags = [
  "-C", "target-cpu=native","-Z", "tune-cpu=native",
  "-C", "llvm-args=-enable-dfa-jump-thread","-Z", "precise-enum-drop-elaboration=yes",
  "-C", "link-args=-fuse-ld=mold --threads","-C", "linker-plugin-lto",
  "-Z", "threads=8"
]
[target.aarch64-linux-android]
linker = "clang"
rustflags = [
  "-C", "target-cpu=native","-Z", "tune-cpu=native",
  "-C", "llvm-args=-enable-dfa-jump-thread","-Z", "precise-enum-drop-elaboration=yes",
  "-C", "link-args=-fuse-ld=mold --threads","-C", "linker-plugin-lto",
  "-Z", "threads=8"
]

[profile.dev]
opt-level = 0
codegen-units = 16
debug = "line-tables-only"
split-debuginfo = "unpacked"

[profile.dev.package."*"]
debug = false

[profile.release.build-override]
inherits = "release"
codegen-units = 16

[profile.debug]
inherits = "dev"
debug = "full"

[target.'cfg(target_os = "linux")']
linker = "clang"
rustflags = [
  "-C", "target-cpu=native","-Z", "tune-cpu=native",
  "-C", "llvm-args=-enable-dfa-jump-thread","-Z", "precise-enum-drop-elaboration=yes",
  "-C", "link-args=-fuse-ld=mold --threads","-C", "linker-plugin-lto",
  "-Z", "threads=8"
]
[target.'cfg(all())']
rustflags = [
  "-C", "target-cpu=native","-Z", "tune-cpu=native",
  "-C", "llvm-args=-enable-dfa-jump-thread","-Z", "precise-enum-drop-elaboration=yes",
  "-C", "link-args=-fuse-ld=mold --threads","-C", "linker-plugin-lto",
  "-Z", "threads=8"
]

[term]
quiet = false
verbose = false
unicode = true
hyperlinks = true
color = "auto"
progress.when = "auto"
progress.term-integration = true
