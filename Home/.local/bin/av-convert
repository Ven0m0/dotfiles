#!/bin/bash

#===============================================================================
# av-convert
# Consolidated format conversion tool
# Usage: av-convert [command] [options]
#===============================================================================

CMD_NAME=$(basename "$0")

usage_main() {
    echo "Usage: $CMD_NAME <command> [options]"
    echo ""
    echo "Commands:"
    echo "  gif       Convert video to GIF (replaces vid2gif)"
    echo "  webp      Convert video to animated WebP (replaces webp)"
    echo "  frame     Extract single frame (replaces extract-frame)"
    echo "  makevid   Create video from image (replaces img2video)"
    echo "  combine   Mux audio and video/image (replaces combine-clips)"
    echo ""
    exit 1
}

# --- GIF ---
cmd_gif() {
    width="320"
    fps="15"
    while getopts ":i:w:f:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            w) width="${OPTARG}" ;;
            f) fps="${OPTARG}" ;;
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME gif -i input [-w width] [-f fps] -o output"; exit 0 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input (-i) required"; exit 1; }
    outfile="${outfile:-${infile%.*}.gif}"

    ffmpeg -hide_banner -v panic -stats -i "$infile" \
        -filter_complex "[0:v] fps=$fps,scale=$width:-1:flags=lanczos,split [a][b];[a] palettegen [p];[b][p] paletteuse" \
        "$outfile"
}

# --- FRAME ---
cmd_frame() {
    time="00:00:00"
    ext="png"
    while getopts ":i:t:f:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            t) time="${OPTARG}" ;;
            f) ext="${OPTARG}" ;; # png or jpg
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME frame -i input [-t timestamp] [-f format] -o output"; exit 0 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input (-i) required"; exit 1; }
    outfile="${outfile:-${infile%.*}-${time//:/-}.$ext}"

    ffmpeg -hide_banner -v panic -stats -ss "$time" -i "$infile" \
        -vframes 1 -q:v 2 \
        "$outfile"
}

# --- COMBINE (Mux) ---
cmd_combine() {
    while getopts ":i:a:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;; # Video or Image
            a) audio="${OPTARG}" ;;
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME combine -i video_or_img -a audio -o output"; exit 0 ;;
        esac
    done

    [ -z "$infile" ] || [ -z "$audio" ] && { echo "Input (-i) and Audio (-a) required"; exit 1; }
    outfile="${outfile:-${infile%.*}-combined.mp4}"

    # Check mime type to see if input is image or video
    mime=$(file --mime-type -b "$infile")

    case "$mime" in
        image/*)
            # Loop image to match audio duration
            ffmpeg -hide_banner -v panic -stats \
                -loop 1 -i "$infile" -i "$audio" \
                -c:v libx264 -tune stillimage -c:a aac -b:a 192k \
                -pix_fmt yuv420p -shortest \
                "$outfile"
            ;;
        video/*)
            # Replace audio in video
            ffmpeg -hide_banner -v panic -stats \
                -i "$infile" -i "$audio" \
                -c:v copy -c:a aac \
                -map 0:v:0 -map 1:a:0 \
                -shortest \
                "$outfile"
            ;;
        *) echo "Unknown file type: $mime"; exit 1 ;;
    esac
}

# Main Dispatch
[ $# -eq 0 ] && usage_main
subcommand=$1
shift
case "$subcommand" in
    gif) cmd_gif "$@" ;;
    frame) cmd_frame "$@" ;;
    combine) cmd_combine "$@" ;;
    # Add other functions here (webp, makevid) following the same pattern
    *) echo "Unknown command: $subcommand"; usage_main ;;
esac
