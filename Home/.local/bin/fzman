#!/usr/bin/env bash
set -euo pipefail; shopt -s nullglob globstar
LC_ALL=C LANG=C IFS=$'\n\t'
# https://github.com/sheepla/fzman
readonly THIS_CMD="${0##*/}"
readonly VERSION='0.0.2'
readonly PROMPT='manpage: '

function _help(){
	echo -e "\
${THIS_CMD} -- manpage finder with fzf

USAGE
    ${THIS_CMD} KEYWORDS...
    ${THIS_CMD} [OPTIONS]
OPTIONS
    -h, --help   Show this help message and exit
    --version    Show version information and exit"
}
function _err(){ echo -e "[ \e[31mERR\e[m ] ${*}" >&2; }
function _test_cmd(){
	for cmd in "${@}"; do
		if command -v "${cmd}" &>/dev/null; then
			return 0
		else
			_err "${cmd}: command not found."
			return 1
		fi
	done
}
function _main(){
	_test_cmd fzf || return 1
	local -a keywords=()
	while [[ $# -gt 0 ]]; do
		case "${1}" in
		-h | --help) _help; return 0;;
		--version) echo "${VERSION}"; return 0 ;;
		*) keywords+=("${1}"); shift;;
		esac
	done
	[[ "${#keywords[@]}" -eq 0 ]] && keywords=('.')
	_select_manual "${keywords[@]}"; return 0
}
function _select_manual(){ man -k "${@}" | sed 's/ * - .*//g' | _fzf_preview; }
function _entry2args(){ local -a arr; read -ra arr <<<"${1//[()]/ }"; echo "${arr[1]}" "${arr[0]}"; }
function _fzf_preview(){
	export -f _entry2args; local -r lookup='_entry2args {} | xargs -n2 -- man'
	fzf --layout=reverse-list --prompt="${PROMPT}" --preview="${lookup} 2>/dev/null" --bind="enter:execute(${lookup})"
}

_main "${@}"
exit $?
