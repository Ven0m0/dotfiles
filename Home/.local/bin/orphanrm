#!/bin/bash
# https://github.com/AquaCheese/orphanrm
# orphanrm - Scan for and remove orphaned packages
# Copyright (c) 2025 AquaCheese
# Licensed under the MIT License
#

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -eq 0 ]]; then
    echo -e "${RED}Error: Do not run this script as root.${NC}"
    echo "This script will request sudo privileges when needed."
    exit 1
fi

# Check if pacman is available
if ! command -v pacman &> /dev/null; then
    echo -e "${RED}Error: pacman not found. This tool only works on Arch-based systems.${NC}"
    exit 1
fi

# Function to display help
show_help() {
    cat << EOF
orphanrm - Scan for and remove orphaned packages

Usage: orphanrm [OPTIONS]

Options:
    -h, --help       Show this help message
    -l, --list       List orphaned packages without prompting for removal
    -a, --auto       Automatically remove all orphaned packages (use with caution)
    -v, --version    Show version information

Description:
    Scans for orphaned packages (packages that were installed as dependencies
    but are no longer required by any installed package) and provides options
    to remove them.

Examples:
    orphanrm            # Interactive mode (default)
    orphanrm --list     # Just list orphaned packages
    orphanrm --auto     # Remove all orphaned packages without confirmation

EOF
}

# Function to display version
show_version() {
    echo "orphanrm version 1.0.0"
    echo "Copyright (c) 2025 AquaCheese"
    echo "Licensed under the MIT License"
}

# Function to get orphaned packages
get_orphans() {
    pacman -Qdtq 2>/dev/null || true
}

# Function to get package info
get_package_info() {
    local pkg=$1
    pacman -Qi "$pkg" 2>/dev/null | grep -E "^(Name|Version|Description|Installed Size)" | sed 's/^/  /'
}

# Function to list orphans with details
list_orphans() {
    local orphans=$1
    local count=$(echo "$orphans" | wc -w)
    
    if [ $count -eq 0 ]; then
        echo -e "${GREEN}No orphaned packages found!${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}Found $count orphaned package(s):${NC}\n"
    
    for pkg in $orphans; do
        echo -e "${BLUE}â–¸ $pkg${NC}"
        size=$(pacman -Qi "$pkg" 2>/dev/null | grep "Installed Size" | awk '{print $4, $5}')
        desc=$(pacman -Qi "$pkg" 2>/dev/null | grep "Description" | cut -d':' -f2- | sed 's/^ //')
        echo -e "  Size: $size"
        echo -e "  Description: $desc"
        echo
    done
}

# Function to remove orphans
remove_orphans() {
    local orphans=$1
    
    echo -e "${YELLOW}The following packages will be removed:${NC}"
    echo "$orphans" | tr ' ' '\n' | sed 's/^/  - /'
    echo
    
    read -p "Do you want to proceed? [y/N] " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Removing orphaned packages...${NC}"
        sudo pacman -Rns $orphans
        echo -e "${GREEN}Done!${NC}"
    else
        echo -e "${YELLOW}Cancelled.${NC}"
    fi
}

# Function for auto removal
auto_remove_orphans() {
    local orphans=$1
    local count=$(echo "$orphans" | wc -w)
    
    echo -e "${YELLOW}Auto-removing $count orphaned package(s)...${NC}"
    sudo pacman -Rns --noconfirm $orphans
    echo -e "${GREEN}Done!${NC}"
}

# Parse arguments
MODE="interactive"

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -l|--list)
            MODE="list"
            shift
            ;;
        -a|--auto)
            MODE="auto"
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use 'orphanrm --help' for usage information."
            exit 1
            ;;
    esac
done

# Main logic
echo -e "${BLUE}Scanning for orphaned packages...${NC}\n"

ORPHANS=$(get_orphans)
ORPHAN_COUNT=$(echo "$ORPHANS" | wc -w)

if [ -z "$ORPHANS" ] || [ $ORPHAN_COUNT -eq 0 ]; then
    echo -e "${GREEN}No orphaned packages found!${NC}"
    exit 0
fi

case $MODE in
    list)
        list_orphans "$ORPHANS"
        ;;
    auto)
        list_orphans "$ORPHANS"
        auto_remove_orphans "$ORPHANS"
        ;;
    interactive)
        list_orphans "$ORPHANS"
        remove_orphans "$ORPHANS"
        ;;
esac

exit 0
