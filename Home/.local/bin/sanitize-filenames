#!/usr/bin/env bash
# sanitize-filenames - Recursively rename files to be Linux-safe
set -euo pipefail; shopt -s globstar nullglob
export LC_ALL=C LANG=C
has(){ command -v "$1" &>/dev/null; }
die(){ printf 'Error: %s\n' "$*" >&2; exit 1; }

has iconv || die "iconv required"
has sd && tool=sd || { has sed && tool=sed || die "sed/sd required"; }
has fd && finder=(fd -tf -td -H -I --exec-batch printf '%s\0') || finder=(find . -print0)

count=0
"${finder[@]}" | sort -zr | while IFS= read -r -d '' f; do
  [[ -e "$f" ]] || continue
  dir="${f%/*}"; base="${f##*/}"
  new=$(printf '%s' "$base" | iconv -f utf8 -t ascii//translit 2>/dev/null | 
    $tool -E 's/[^A-Za-z0-9._-]+/_/g; s/^_+|_+$//g; s/_+/_/g')
  [[ "$base" != "$new" ]] || continue
  target="$dir/$new"
  [[ ! -e "$target" ]] || { printf 'Collision: %s\n' "$f" >&2; continue; }
  mv -T -- "$f" "$target" && printf '%s â†’ %s\n' "$base" "$new" && ((count++)) || :
done
printf 'Renamed %d item(s)\n' "$count"
