#!/bin/bash

#===============================================================================
# av-edit
# Consolidated media editing tool
# Usage: av-edit [command] [options]
#===============================================================================

#===============================================================================
# Global Variables & Helpers
#===============================================================================
CMD_NAME=$(basename "$0")

usage_main() {
    echo "Usage: $CMD_NAME <command> [options]"
    echo ""
    echo "Commands:"
    echo "  trim      Trim video/audio (replaces trim-clip & trim-clip-to)"
    echo "  fade      Fade in/out (replaces fade-clip)"
    echo "  norm      Normalize audio (replaces normalize/loudnorm/fade-normalize)"
    echo "  silence   Add silent audio (replaces audio-silence)"
    echo ""
    echo "Run '$CMD_NAME <command> -h' for command-specific help."
    exit 1
}

check_deps() {
    command -v ffmpeg >/dev/null 2>&1 || { echo >&2 "ffmpeg is required."; exit 1; }
}

# Helper to check for aac lib
get_aac_codec() {
    if ffmpeg -hide_banner -h encoder=libfdk_aac >/dev/null 2>&1; then
        echo "libfdk_aac"
    else
        echo "aac"
    fi
}

#===============================================================================
# Commands
#===============================================================================

# --- TRIM ---
cmd_trim() {
    mode="duration" # Default to -t (duration), can switch to -to (timestamp)
    while getopts ":i:s:e:t:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            s) start="${OPTARG}" ;;
            e) end="${OPTARG}"; mode="timestamp" ;; # -e for End timestamp
            t) duration="${OPTARG}"; mode="duration" ;; # -t for Duration
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME trim -i input -s 00:00:00 [-t duration | -e end_time] -o output"; exit 0 ;;
            *) echo "Invalid option: -${OPTARG}" >&2; exit 1 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input file (-i) required"; exit 1; }

    # Logic to determine trim flag
    if [ "$mode" = "timestamp" ]; then
        trim_flag="-to $end"
        suffix="trimmed-to-$end"
    else
        trim_flag="-t $duration"
        suffix="trimmed-${duration}"
    fi

    outfile="${outfile:-${infile%.*}-${suffix}.${infile##*.}}"

    ffmpeg -hide_banner -v panic -stats \
        -ss "${start:-00:00:00}" \
        -i "$infile" \
        $trim_flag \
        -c:v libx264 -profile:v high -pix_fmt yuv420p \
        -c:a $(get_aac_codec) \
        -movflags +faststart \
        "$outfile"
}

# --- NORMALIZE ---
cmd_norm() {
    fade_len="0" # Default 0 means no fade
    while getopts ":i:f:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            f) fade_len="${OPTARG}" ;; # Optional fade duration
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME norm -i input [-f fade_seconds] -o output"; exit 0 ;;
            *) echo "Invalid option: -${OPTARG}" >&2; exit 1 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input file (-i) required"; exit 1; }
    outfile="${outfile:-${infile%.*}-normalized.mp4}"

    echo "Analyzing loudness..."
    # First pass: analyze
    stats=$(ffmpeg -hide_banner -i "$infile" -af "loudnorm=I=-16:TP=-1.5:LRA=11:print_format=summary" -f null - 2>&1 | tail -n 12)

    # Parse stats using awk (simplified from your original script)
    meas_I=$(echo "$stats" | awk '/Input Integrated:/ {print $3}')
    meas_TP=$(echo "$stats" | awk '/Input True Peak:/ {print $4}')
    meas_LRA=$(echo "$stats" | awk '/Input LRA:/ {print $3}')
    meas_thresh=$(echo "$stats" | awk '/Input Threshold:/ {print $3}')
    offset=$(echo "$stats" | awk '/Target Offset:/ {print $3}')

    # Filter construction
    loudnorm_filter="loudnorm=I=-16:TP=-1.5:LRA=11:measured_I=$meas_I:measured_LRA=$meas_LRA:measured_TP=$meas_TP:measured_thresh=$meas_thresh:offset=$offset:linear=true"

    if [ "$fade_len" != "0" ]; then
        # If fade requested (merges fade-normalize functionality)
        dur=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$infile")
        fade_out_st=$(echo "$dur - $fade_len" | bc)
        audio_filter="afade=t=in:st=0:d=$fade_len,afade=t=out:st=$fade_out_st:d=$fade_len,$loudnorm_filter"
        video_filter="fade=t=in:st=0:d=$fade_len,fade=t=out:st=$fade_out_st:d=$fade_len"

        ffmpeg -hide_banner -v panic -stats -i "$infile" \
            -filter_complex "[0:v]$video_filter[v];[0:a]$audio_filter[a]" \
            -map "[v]" -map "[a]" \
            -c:v libx264 -preset fast -crf 18 \
            -c:a $(get_aac_codec) \
            "$outfile"
    else
        # Just normalize
        ffmpeg -hide_banner -v panic -stats -i "$infile" \
            -af "$loudnorm_filter" \
            -c:v copy \
            -c:a $(get_aac_codec) \
            "$outfile"
    fi
}

# --- FADE ---
cmd_fade() {
    dur="0.5"
    while getopts ":i:d:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            d) dur="${OPTARG}" ;;
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME fade -i input [-d duration] -o output"; exit 0 ;;
            *) echo "Invalid option: -${OPTARG}" >&2; exit 1 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input file (-i) required"; exit 1; }
    outfile="${outfile:-${infile%.*}-fade.mp4}"

    video_len=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$infile")
    fade_out_start=$(echo "$video_len - $dur" | bc -l)

    ffmpeg -hide_banner -v panic -stats -i "$infile" \
        -filter_complex "[0:v]fade=t=in:st=0:d=$dur,fade=t=out:st=$fade_out_start:d=$dur[v];[0:a]afade=t=in:st=0:d=$dur,afade=t=out:st=$fade_out_start:d=$dur[a]" \
        -map "[v]" -map "[a]" \
        -c:v libx264 -crf 18 -pix_fmt yuv420p \
        -c:a $(get_aac_codec) \
        "$outfile"
}

# --- SILENCE ---
cmd_silence() {
    # Replaces audio-silence
    while getopts ":i:o:h" opt; do
        case ${opt} in
            i) infile="${OPTARG}" ;;
            o) outfile="${OPTARG}" ;;
            h) echo "Usage: $CMD_NAME silence -i input -o output"; exit 0 ;;
            *) echo "Invalid option: -${OPTARG}" >&2; exit 1 ;;
        esac
    done

    [ -z "$infile" ] && { echo "Input file (-i) required"; exit 1; }
    outfile="${outfile:-${infile%.*}-silence.mp4}"

    ffmpeg -hide_banner -v panic -stats \
        -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=44100 \
        -i "$infile" \
        -shortest -c:v copy -c:a $(get_aac_codec) \
        -map 0:a -map 1:v \
        "$outfile"
}


#===============================================================================
# Main Dispatch
#===============================================================================

check_deps
[ $# -eq 0 ] && usage_main

subcommand=$1
shift

case "$subcommand" in
    trim) cmd_trim "$@" ;;
    norm) cmd_norm "$@" ;;
    fade) cmd_fade "$@" ;;
    silence) cmd_silence "$@" ;;
    *) echo "Unknown command: $subcommand"; usage_main ;;
esac
