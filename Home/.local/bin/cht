#!/usr/bin/env bash
# cht - cheat.sh wrapper with fuzzy search
set -euo pipefail
shopt -s lastpipe nullglob
export LC_ALL=C LANG=C

has(){ command -v "$1" &>/dev/null; }
die(){ printf 'Error: %s\n' "$*" >&2; exit 1; }

# Find available tools
for c in curl wget; do has "$c" && HTTP="$c" && break; done
[[ -z ${HTTP:-} ]] && die "curl or wget is required"

for f in sk fzf; do has "$f" && FZF="$f" && break; done
[[ -z ${FZF:-} ]] && die "sk or fzf is required"

for p in bat batcat less; do has "$p" && PAGER="$p" && break; done
PAGER="${PAGER:-less}"

get(){
  case "${HTTP}" in
    curl) curl -fsL -A curl "$@" ;;
    wget) wget -qO- "$@" ;;
    *) die "Invalid HTTP client: ${HTTP}" ;;
  esac
}

readonly CHT_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/cht_list"
readonly CHT_URL="cheat.sh"

_cache(){
  [[ -f "${CHT_CACHE}" && -n "$(find "${CHT_CACHE}" -mtime -7 2>/dev/null)" ]] && return 0
  mkdir -p "${CHT_CACHE%/*}"
  get "${CHT_URL}/:list" > "${CHT_CACHE}" 2>/dev/null || die "Failed to fetch sheet list"
}

_browse(){
  local sel q url
  _cache

  sel=$("${FZF}" --ansi --cycle --reverse --no-mouse --prompt='cht> ' \
    --preview="curl -fsL ${CHT_URL}/{} 2>/dev/null | head -50" \
    --preview-window=right:60%:wrap < "${CHT_CACHE}") || return 1

  read -rp "Query [${sel}] (empty=summary): " q
  q="${q// /+}"
  url="${CHT_URL}/${sel}${q:+/${q}}"

  printf '\n→ %s\n\n' "${url}"
  get "${url}" | "${PAGER}"
}

_query(){
  local lang="${1:-}" topic="${2:-}" flags="" url

  [[ -z "${lang}" ]] && die "Language/topic required"

  [[ ${search:-0} -eq 1 ]] && lang="~${lang}" && topic="~${topic}"

  if [[ -n "${topic}" ]]; then
    url="${CHT_URL}/${lang}/${topic}"
  else
    url="${CHT_URL}/${lang}"
  fi

  [[ -n ${insens:-} ]] && flags+="i"
  [[ -n ${bound:-} ]] && flags+="b"
  [[ -n ${recur:-} ]] && flags+="r"
  [[ -n "${flags}" ]] && url+="/${flags}"

  get "${url}"
}

usage(){
  cat <<'EOF'
cht - cheat.sh wrapper with fuzzy search

USAGE:
  cht [-sibr] [lang] [topic]
  cht -l          Browse/list all sheets
  cht -u          Update cache

FLAGS:
  -s  Search mode (~)
  -i  Case insensitive
  -b  Word boundary
  -r  Recursive
  -l  Browse/list mode
  -u  Update cache
  -h  Show help

EXAMPLES:
  cht python          # Browse Python cheatsheets
  cht -s bash array   # Search for bash array info
  cht rust Vec        # Show Rust Vec documentation
EOF
}

search=0 insens="" bound="" recur=""

while getopts "sibrluha" o; do
  case "${o}" in
    s) search=1 ;;
    i) insens=1; search=1 ;;
    b) bound=1; search=1 ;;
    r) recur=1; search=1 ;;
    l) _browse; exit 0 ;;
    u) rm -f "${CHT_CACHE}"; _cache; printf '✓ Cache updated\n'; exit 0 ;;
    h|*) usage; exit 0 ;;
  esac
done
shift $((OPTIND - 1))

if [[ $# -eq 0 ]]; then
  _browse
elif [[ $# -eq 1 ]]; then
  _query "$1"
else
  _query "$1" "$2"
fi
