#!/usr/bin/env bash
# https://github.com/joehillen/paruz
shopt -s lastpipe nullglob globstar
export SHELL="$(command -v bash)" LC_ALL=C LANG=C

command -v bat &>/dev/null && PARU_PAGER='bat -p'

if [[ -z $PARUZ ]]; then
  if command -v paru &>/dev/null; then
    PARUZ=paru
  else
    PARUZ='sudo pacman'
  fi
fi

__paruz_help(){
  PROG=$(basename "$0")
  cat >&2 <<EOF
Usage: $PROG [OPTS]

A fzf terminal UI for paru or pacman.
The package manager can be changed with the environment variables: PARUZ

Keybindings:
  TAB                    Select
  Shift+TAB              Deselect

OPTS:
  -h, --help             Print this message

  All other options are passed to the package manager.
  Default: -S (install)

Examples:
  paruz -S --nocleanafter
  paruz -R
  PARUZ=yay paruz
EOF
  exit 1
}

__fzf_preview(){ "$PARUZ" --color=always --noconfirm -Si "$1" | grep --color=never -v '^ '; }
__paruz_list(){ "$PARUZ" --color=always --noconfirm -Sl | sed -E 's: :/:; s/ (\x1b\[[0-9;]*m)?unknown-version/\1/'; }

while [[ -n $1 ]]; do
  case $1 in
  -h | --help)  __paruz_help ;;
  __fzf_preview) shift; __fzf_preview "$@" ;;
  *) break ;;
  esac; shift
done

ARGS=("$@")
[[ ${#ARGS[@]} -eq 0 ]] && ARGS=("-S")
declare -a PICKS
__paruz_list | fzf -m --ansi --preview="'${BASH_SOURCE[0]}' __fzf_preview {1}" | readarray -t PICKS
[[ ${#PICKS[@]} -eq 0 ]] && exit 0
declare -a PKGS
for PICK in "${PICKS[@]}"; do PKGS+=("${PICK%% *}"); done
exec $PARUZ "${ARGS[@]}" "${PKGS[@]}"
