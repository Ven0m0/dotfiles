# Advanced lefthook configuration
# https://github.com/evilmartians/lefthook

skip_output:
  - meta
  - execution
output:
  - summary
  - skips
colors: true
no_tty: false

pre-commit:
  parallel: true
  commands:
    # Shell script validation
    shellcheck:
      glob: "*.{sh,bash}"
      run: |
        shellcheck -x -s bash -e SC1091 -f gcc {staged_files} || :
      stage_fixed: true
    # Shell formatting
    shfmt:
      glob: "*.{sh,bash}"
      run: |
        shfmt -i 2 -ci -sr -bn -w {staged_files}
      stage_fixed: true
    # YAML lint
    yamllint:
      glob: "*.{yml,yaml}"
      run: |
        yamllint -f parsable {staged_files} || :
    # JSON validation
    json-validate:
      glob: "*.json"
      run: |
        for f in {staged_files}; do
          jaq -e . "$f" &>/dev/null || jq -e . "$f" || { printf "Invalid JSON: %s\n" "$f"; exit 1; }
        done
    # Markdown lint
    markdownlint:
      glob: "*.md"
      run: |
        markdownlint --fix {staged_files} || :
      stage_fixed: true
    # Remove trailing whitespace
    trim-whitespace:
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2?|ttf|eot|mp[34]|webm|pdf|zip|gz|xz|zst|tar)$"
      run: |
        sd '[ \t]+$' '' {staged_files}
      stage_fixed: true
    # Strip Unicode zero-width chars
    strip-hidden-unicode:
      glob: "*"
      exclude: "\\.(png|jpe?g|gif|webp|ico|svg|woff2?|ttf|eot|mp[34]|webm|pdf|zip|gz|xz|zst|tar)$"
      run: |
        sd '[\u200B\u200C\u200D\u202F\u00AD\uFEFF]' '' {staged_files}
      stage_fixed: true
    # Normalize line endings
    normalize-eol:
      glob: "*.{sh,bash,yml,yaml,json,md,txt,toml,ini,conf,cfg}"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] && dos2unix -q "$f" 2>/dev/null || sed -i 's/\r$//' "$f"
        done
      stage_fixed: true
    # Ensure shebang
    fix-shebang:
      glob: "*.{sh,bash}"
      run: |
        for f in {staged_files}; do
          [[ -f "$f" ]] || continue
          if ! head -n1 "$f" | grep -qE '^#!'; then
            { printf '#!/usr/bin/env bash\n'; cat "$f"; } > "$f.tmp" && mv "$f.tmp" "$f"
          fi
        done
      stage_fixed: true
    # Check for large files
    check-filesize:
      run: |
        max_kb=5120
        for f in {staged_files}; do
          [[ -f "$f" ]] || continue
          size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null || echo 0)
          (( size > max_kb * 1024 )) && printf "Large file: %s (%d KB)\n" "$f" "$((size/1024))"
        done
    # Detect secrets/keys
    detect-secrets:
      run: |
        rg -i -e '(password|api[_-]?key|secret|token|bearer)\s*[:=]\s*["\047]?[a-z0-9_-]{20,}' {staged_files} || :
    # Check for debug statements
    check-debug:
      glob: "*.{sh,bash,js,ts,py,rb}"
      run: |
        rg -i '\b(console\.log|debugger|binding\.pry|set -x|echo.*DEBUG)\b' {staged_files} && exit 1 || :

commit-msg:
  commands:
    # Conventional commits
    commitlint:
      run: |
        msg=$(cat {1})
        if ! grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}' <<< "$msg"; then
          printf "Commit message must follow Conventional Commits:\n  type(scope?): subject\n\nTypes: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert\n"
          exit 1
        fi
    # Check message length
    msg-length:
      run: |
        msg=$(cat {1})
        subject=$(head -n1 <<< "$msg")
        [[ ${#subject} -gt 72 ]] && { printf "Subject line exceeds 72 chars (%d)\n" "${#subject}"; exit 1; }
        :
    # Prevent WIP commits
    no-wip:
      run: |
        msg=$(cat {1})
        grep -qiE '\b(wip|todo|fixme|hack)\b' <<< "$msg" && { printf "Remove WIP/TODO/FIXME/HACK from commit message\n"; exit 1; }
        :

pre-push:
  parallel: true
  commands:
    # Run tests if present
    test:
      run: |
        [[ -f Makefile ]] && make test &>/dev/null && exit 0
        [[ -f package.json ]] && npm test &>/dev/null && exit 0
        [[ -f Cargo.toml ]] && cargo test &>/dev/null && exit 0
        [[ -f go.mod ]] && go test ./... &>/dev/null && exit 0
        :
    # Check branch name
    branch-name:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if ! grep -qE '^(main|master|develop|release/.+|hotfix/.+|feature/.+|bugfix/.+)$' <<< "$branch"; then
          printf "Branch name should follow git-flow: feature/*, bugfix/*, release/*, hotfix/*\n"
        fi
    # Prevent push to protected branches
    protect-branches:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if grep -qE '^(main|master)$' <<< "$branch"; then
          printf "Direct push to %s prohibited\n" "$branch"
          exit 1
        fi

post-merge:
  commands:
    # Update dependencies
    update-deps:
      run: |
        [[ -f package-lock.json ]] && npm ci &>/dev/null
        [[ -f yarn.lock ]] && yarn install --frozen-lockfile &>/dev/null
        [[ -f pnpm-lock.yaml ]] && pnpm install --frozen-lockfile &>/dev/null
        [[ -f Cargo.lock ]] && cargo fetch &>/dev/null
        [[ -f go.sum ]] && go mod download &>/dev/null
        :
    # Clean build artifacts
    clean-build:
      run: |
        rm -rf node_modules/.cache target/debug .pytest_cache __pycache__ &>/dev/null || :

post-checkout:
  commands:
    # Update submodules
    submodules:
      run: |
        [[ -f .gitmodules ]] && git submodule update --init --recursive &>/dev/null || :

prepare-commit-msg:
  commands:
    # Add branch name to commit
    branch-prefix:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        [[ "$branch" =~ ^(feature|bugfix|hotfix)/([A-Z]+-[0-9]+) ]] && {
          ticket="${BASH_REMATCH[2]}"
          msg=$(cat {1})
          grep -q "$ticket" <<< "$msg" || sed -i "1s/^/$ticket: /" {1}
        }
        :
