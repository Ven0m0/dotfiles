# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json
severity: warning
# ==============================================================================
# UTILITIES (Reusable Sub-Rules)
# ==============================================================================
utils:
  # --- TypeScript/JavaScript ---
  is-console:
    kind: member_expression
    pattern: console.$METHOD
    has:
      kind: property_identifier
      regex: ^(log|debug|info|warn|error)$
  is-debugger:
    kind: debugger_statement
  has-todo:
    kind: comment
    regex: \b(TODO|FIXME|XXX|HACK)\b
  unsafe-eval:
    any:
      - pattern: eval($EXPR)
      - pattern: new Function($$$ARGS)
      - pattern: setTimeout($STRING, $$$)
        has:
          kind: string
  dangerous-html:
    any:
      - pattern: innerHTML = $VAL
      - pattern: outerHTML = $VAL
      - pattern: insertAdjacentHTML($POS, $VAL)
      - pattern: document.write($VAL)
      - pattern: document.writeln($VAL)
  # --- Bash Utilities ---
  has-glob-pattern:
    kind: case_item
    regex: '[\*\?\[]'
  is-flag-case:
    kind: case_item
    regex: '^-[a-zA-Z]|--[a-z]'
  is-shebang-line:
    kind: comment
    regex: '^#!/'
# ==============================================================================
# RULES
# ==============================================================================
rules:
  # ----------------------------------------------------------------------------
  # TYPESCRIPT / JAVASCRIPT — Security & Style
  # ----------------------------------------------------------------------------
  - id: no-console
    language: typescript
    message: Remove console statements (use logger/debug build)
    note: 'Production code should use structured logging'
    utils: is-console
    severity: error
    fix: ''
  - id: no-debugger
    language: typescript
    message: Remove debugger statement
    utils: is-debugger
    severity: error
    fix: ''
  - id: no-todo-comments
    languages: [typescript, javascript, bash]
    message: Resolve TODO/FIXME comment
    note: 'Convert to tracked issues or resolve inline'
    utils: has-todo
    severity: warning
  - id: no-unsafe-eval
    language: typescript
    message: Avoid eval and Function constructor (code injection risk)
    utils: unsafe-eval
    severity: error
  - id: no-dangerous-html
    language: typescript
    message: Avoid direct HTML manipulation (XSS risk)
    note: 'Use textContent, createElement, or DOMPurify'
    utils: dangerous-html
    severity: warning
  - id: prefer-const
    language: typescript
    message: Use const for variables that are never reassigned
    rule:
      kind: lexical_declaration
      pattern: let $VAR = $INIT
      not:
        any:
          - inside:
              kind: for_statement
          - inside:
              kind: assignment_expression
              has:
                field: left
                pattern: $VAR
    fix: const $VAR = $INIT
    severity: info
  - id: no-var
    language: typescript
    message: Use let or const instead of var
    rule:
      kind: variable_declaration
      pattern: var $VAR = $INIT
    fix: let $VAR = $INIT
    severity: error
  - id: prefer-arrow-function
    language: typescript
    message: Prefer arrow functions for callbacks (lexical this)
    rule:
      kind: function_expression
      inside:
        any:
          - kind: arguments
          - kind: array
    fix: ($PARAMS) => $BODY
    severity: hint
  - id: no-empty-catch
    language: typescript
    message: Empty catch block - handle error or remove try-catch
    note: 'At minimum log error or add comment explaining silence'
    rule:
      kind: catch_clause
      has:
        kind: statement_block
        pattern: '{}'
    severity: warning
  - id: prefer-strict-equality
    language: typescript
    message: Use === instead of == (avoid type coercion)
    rule:
      kind: binary_expression
      any:
        - pattern: $A == $B
        - pattern: $A != $B
    fix: $A === $B
    severity: error
  # ----------------------------------------------------------------------------
  # BASH — Critical Standards (MUST HAVE)
  # ----------------------------------------------------------------------------
  - id: bash-require-env-shebang
    language: bash
    message: Use #!/usr/bin/env bash shebang
    note: 'Portable, finds bash via PATH'
    rule:
      utils: is-shebang-line
      regex: '^#!/bin/(ba)?sh'
    fix: '#!/usr/bin/env bash'
    severity: error
  - id: bash-banned-backticks
    language: bash
    message: Use $() instead of backticks (nestable, POSIX)
    rule:
      kind: command_substitution
      regex: '`.*`'
    severity: error
  - id: bash-banned-eval
    language: bash
    message: Never use eval (arbitrary code execution risk)
    rule:
      kind: command
      pattern: eval $$$
    severity: error
  - id: bash-banned-expr
    language: bash
    message: Use (()) or [[ ]] instead of expr (fork overhead)
    rule:
      kind: command
      pattern: expr $$$
    severity: error
  - id: bash-banned-ls-parse
    language: bash
    message: Never parse ls output (use globs, find, fd)
    note: 'ls output is not machine-parseable'
    rule:
      kind: pipeline
      pattern: ls $$$ARGS | $CMD
    severity: error
  # ----------------------------------------------------------------------------
  # BASH — Bashisms (Style Enforcement)
  # ----------------------------------------------------------------------------
  - id: bash-function-no-space
    language: bash
    message: Remove space before function brace
    note: 'fn(){ not fn() {'
    rule:
      kind: function_definition
      regex: '\)\s+\{'
    severity: error
  - id: bash-redirect-compact
    language: bash
    message: Use &>/dev/null instead of >/dev/null 2>&1
    note: 'Bash 4.0+ shorthand, 14 chars vs 20'
    rule:
      kind: command
      regex: '>\s*/dev/null\s+2>&1'
    severity: error
  - id: bash-redirect-no-space
    language: bash
    message: Remove space before /dev/null
    note: '>/dev/null not > /dev/null'
    rule:
      kind: redirect
      regex: '>\s+/dev/null'
    severity: error
  - id: bash-idiom-colon-or
    language: bash
    message: "Use ':' instead of 'true' (builtin)"
    note: '1 char, 0 forks'
    rule:
      pattern: $CMD || true
    fix: '$CMD || :'
    severity: info
  - id: bash-idiom-colon-while
    language: bash
    message: "Use ':' instead of 'true' in loops"
    rule:
      pattern: while true; do $$$BODY; done
    fix: 'while :; do $$$BODY; done'
    severity: info
  - id: bash-test-double-bracket
    language: bash
    message: Use [[ ]] instead of [ ] (bash builtin, safer)
    note: 'No word splitting, supports regex, no quoting needed'
    rule:
      kind: test_command
      regex: '^\[\s'
      not:
        regex: '^\[\['
    severity: error
  - id: bash-printf-over-echo-n
    language: bash
    message: Use printf instead of echo -n (portable)
    note: 'echo behavior varies BSD vs GNU'
    rule:
      kind: command
      pattern: echo -n $$$
    severity: warning
  # ----------------------------------------------------------------------------
  # BASH — Safety (Prevent Word Splitting & Injection)
  # ----------------------------------------------------------------------------
  - id: bash-unquoted-var
    language: bash
    message: Quote variable to prevent word splitting/globbing
    note: 'Exceptions: [[ ]], (( )), assignments, case items'
    rule:
      kind: expansion
      regex: ^\$[A-Za-z_][A-Za-z0-9_]*$
      not:
        inside:
          any:
            - kind: double_quoted_string
            - kind: single_quoted_string
            - kind: arithmetic_expansion
            - kind: test_command
            - kind: assignment
            - kind: case_item
            - kind: for_statement
    severity: error
  - id: bash-unquoted-command-sub
    language: bash
    message: Quote command substitution
    rule:
      kind: command_substitution
      not:
        inside:
          any:
            - kind: double_quoted_string
            - kind: test_command
            - kind: assignment
    severity: error
  # ----------------------------------------------------------------------------
  # BASH — Performance (Avoid Forks, Use Builtins)
  # ----------------------------------------------------------------------------
  - id: bash-useless-cat
    language: bash
    message: Useless cat - redirect directly (saves fork)
    rule:
      kind: pipeline
      pattern: cat $FILE | $CMD
    fix: $CMD < $FILE
    severity: warning
  - id: bash-prefer-mapfile
    language: bash
    message: Use mapfile instead of while read (10-100x faster)
    note: 'Bash 4.0+; use -t for trim, -d for delimiter'
    rule:
      kind: while_statement
      pattern: |
        while IFS= read -r $VAR; do
          $ARRAY+=("$VAR")
        done
    fix: mapfile -t $ARRAY
    severity: info
  - id: bash-prefer-parameter-expansion
    language: bash
    message: Use parameter expansion instead of sed (no fork)
    note: '${var#prefix}, ${var%suffix}, ${var//search/replace}'
    rule:
      any:
        - pattern: echo $VAR | sed 's/^$PREFIX//'
        - pattern: echo $VAR | awk '{gsub(/^$PREFIX/,"")}1'
    fix: echo "${VAR#$PREFIX}"
    severity: warning
  - id: bash-no-subshell-in-loop
    language: bash
    message: Avoid pipeline in loop (spawns subshell per iteration)
    note: 'Use process substitution or pre-process data'
    rule:
      kind: pipeline
      inside:
        any:
          - kind: while_statement
          - kind: for_statement
    severity: warning
  - id: bash-prefer-builtin-printf
    language: bash
    message: Use builtin printf, not /usr/bin/printf
    rule:
      kind: command
      pattern: /usr/bin/printf $$$
    fix: printf $$$
    severity: info
  # ----------------------------------------------------------------------------
  # BASH — Modern Tools (Prefer Rust/Fast Alternatives)
  # ----------------------------------------------------------------------------
  - id: bash-prefer-fd-over-find
    language: bash
    message: Consider fd instead of find (faster, better UX)
    note: 'Fallback to find if fd unavailable'
    rule:
      kind: command
      pattern: find $$$ARGS -name $PATTERN
    severity: hint
  - id: bash-prefer-rg-over-grep
    language: bash
    message: Consider rg instead of grep (10-100x faster)
    note: 'Fallback to grep if rg unavailable'
    rule:
      kind: command
      pattern: grep -r $$$
    severity: hint
  - id: bash-prefer-sd-over-sed
    language: bash
    message: Consider sd instead of sed (safer syntax)
    note: 'Fallback to sed if sd unavailable'
    rule:
      kind: pipeline
      pattern: $CMD | sed 's/$$$'
    severity: hint
  # ----------------------------------------------------------------------------
  # BASH — Case Optimization (Selective Inlining)
  # ----------------------------------------------------------------------------
  - id: bash-case-trivial-inline
    language: bash
    message: Inline trivial case to [[ ]] (faster)
    note: 'Single branch, no globs, not in loops'
    rule:
      kind: case_statement
      all:
        - pattern: |
            case $VAR in
              $PATTERN) $CMD ;;
            esac
        - not:
            utils: has-glob-pattern
        - not:
            inside:
              any:
                - kind: while_statement
                - kind: for_statement
    fix: '[[ $VAR == $PATTERN ]] && $CMD'
    severity: hint
  - id: bash-case-two-to-if
    language: bash
    message: Consider if-else for two-branch case (clearer)
    note: 'Case shines at 4+ branches'
    rule:
      kind: case_statement
      all:
        - pattern: |
            case $VAR in
              $PATTERN1) $CMD1 ;;
              *) $CMD2 ;;
            esac
        - not:
            utils: is-flag-case
        - not:
            inside:
              kind: while_statement
    fix: if [[ $VAR == $PATTERN1 ]]; then $CMD1; else $CMD2; fi
    severity: hint
  - id: bash-case-getopt-preserve
    language: bash
    message: Getopt/flag case preserved (idiomatic)
    rule:
      kind: case_statement
      has:
        utils: is-flag-case
    severity: off
  # ----------------------------------------------------------------------------
  # BASH — Additional Optimizations
  # ----------------------------------------------------------------------------
  - id: bash-declare-array
    language: bash
    message: Declare arrays explicitly for clarity
    note: 'declare -a arr or declare -A assoc'
    rule:
      kind: assignment
      regex: '^[A-Za-z_][A-Za-z0-9_]*=\([^)]+\)'
      not:
        inside:
          kind: declaration_command
    severity: hint
  - id: bash-local-in-function
    language: bash
    message: Use local for function variables (avoid globals)
    rule:
      kind: assignment
      inside:
        kind: function_definition
      not:
        inside:
          kind: declaration_command
    severity: warning
  - id: bash-prefer-literal-search
    language: bash
    message: Use -F for literal grep/rg search (faster)
    note: 'Avoids regex engine overhead'
    rule:
      kind: command
      any:
        - pattern: grep $PATTERN
        - pattern: rg $PATTERN
      not:
        has:
          regex: '\s-[EFPGo]'
    severity: hint
# ==============================================================================
# FILE FILTERS (Performance: Scope Scans)
# ==============================================================================
# Uncomment if using . ast-grep/rules/ structure:
# files:
#   - "**/*.sh"
#   - "**/*.bash"
#   - "**/*.ts"
#   - "**/*.tsx"
#   - "**/*.js"
#   - "**/*.jsx"
# ignores:
#   - "**/node_modules/**"
#   - "**/.git/**"
#   - "**/dist/**"
#   - "**/build/**"
