#!/usr/bin/env bash
# YADM Bootstrap Script for Subdirectory-Based Dotfiles
# This script handles the deployment of dotfiles organized in Home/, etc/, usr/ subdirectories
set -euo pipefail
export LC_ALL=C LANG=C

# Helper functions
has(){ command -v "$1" &>/dev/null; }
info(){ printf '\e[1;34m==>\e[0m \e[1m%s\e[0m\n' "$*"; }
success(){ printf '\e[1;32m==>\e[0m \e[1m%s\e[0m\n' "$*"; }
warn(){ printf '\e[1;33m==> WARNING:\e[0m \e[1m%s\e[0m\n' "$*"; }
error(){ printf '\e[1;31m==> ERROR:\e[0m \e[1m%s\e[0m\n' "$*" >&2; }
die(){ error "$*"; exit 1; }

# Determine repository directory
REPO_DIR="$(yadm rev-parse --show-toplevel 2>/dev/null)" || {
  REPO_DIR="${HOME}/.local/share/yadm/repo.git"
}

[[ -d "$REPO_DIR" ]] || die "Repository directory not found: $REPO_DIR"

info "YADM Bootstrap starting..."
info "Repository: $REPO_DIR"

# ============================================================================
# 1. Deploy User-Level Dotfiles (Home/ → ~/)
# ============================================================================
deploy_home_dotfiles() {
  local home_dir="${REPO_DIR}/Home"

  if [[ ! -d "$home_dir" ]]; then
    warn "Home/ directory not found at: $home_dir"
    return 0
  fi

  info "Deploying user dotfiles from Home/ → ~/"

  if has rsync; then
    rsync -av --exclude='.git' --exclude='.gitignore' "${home_dir}/" "${HOME}/"
  else
    warn "rsync not available, using cp (install rsync for better deployment)"
    cp -rf "${home_dir}/." "${HOME}/"
  fi

  success "User dotfiles deployed successfully"
}

# ============================================================================
# 2. Install Base Dependencies
# ============================================================================
install_base_deps() {
  info "Installing base dependencies..."

  if has pacman; then
    local pac_cmd="sudo pacman"
    has paru && pac_cmd="paru"
    has yay && pac_cmd="yay"

    $pac_cmd -Sq --needed --noconfirm \
      git gitoxide aria2 curl zsh fd sd ripgrep bat jq zoxide starship fzf \
      stow tuckr rsync || warn "Some packages may have failed to install"
  elif has apt-get; then
    sudo apt-get update -y
    sudo apt-get install -y \
      git curl zsh fd-find ripgrep bat jq fzf stow rsync || warn "Some packages may have failed"

    # Install zoxide on Debian/Ubuntu
    if ! has zoxide; then
      curl -fsSL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash -s -- -y
    fi
  else
    warn "Unknown package manager. Please install dependencies manually."
  fi
}

# ============================================================================
# 3. Configure Shell and Environment
# ============================================================================
configure_shell() {
  info "Configuring shell environment..."

  mkdir -p "${HOME}/.config" "${HOME}/bin" "${HOME}/.local/bin"

  # Set Zsh as default shell if available
  if has zsh; then
    local zsh_path
    zsh_path="$(command -v zsh)"

    if [[ "$SHELL" != "$zsh_path" ]]; then
      info "Setting Zsh as default shell..."
      chsh -s "$zsh_path" "$USER" 2>/dev/null || warn "Could not change shell. Run: chsh -s $zsh_path"
    fi
  fi

  # Install starship preset if starship is available
  if has starship && [[ ! -f ~/.config/starship.toml ]]; then
    info "Installing Starship nerd-font preset..."
    starship preset nerd-font-symbols -o ~/.config/starship.toml
  fi

  # Add zoxide to .zshrc if needed
  if has zoxide; then
    local zshrc="${ZDOTDIR:-$HOME}/.zshrc"
    if [[ -f "$zshrc" ]] && ! grep -q 'zoxide init' "$zshrc" 2>/dev/null; then
      info "Adding zoxide integration to .zshrc..."
      {
        echo ''
        echo '# zoxide - smarter cd command'
        echo 'eval "$(zoxide init --cmd cd zsh)"'
      } >> "$zshrc"
    fi
  fi
}

# ============================================================================
# 4. Deploy System Configs (etc/ usr/ → / via tuckr)
# ============================================================================
deploy_system_configs() {
  if ! has tuckr; then
    warn "tuckr not installed. System configs (etc/, usr/) will not be deployed."
    warn "Install tuckr and run: sudo tuckr link -d $REPO_DIR -t / etc usr"
    return 0
  fi

  info "Deploying system configurations with tuckr..."

  for pkg in etc usr; do
    if [[ -d "${REPO_DIR}/${pkg}" ]]; then
      info "Linking $pkg/ → /"
      sudo tuckr link -d "$REPO_DIR" -t / "$pkg" || warn "Failed to link $pkg"
    else
      warn "Directory not found: ${REPO_DIR}/${pkg}"
    fi
  done

  success "System configurations deployed"
}

# ============================================================================
# 5. OS/Host-Specific Configurations (yadm alternates)
# ============================================================================
setup_alternates() {
  info "Processing yadm alternate files..."
  yadm alt 2>/dev/null || warn "No alternate files to process"
}

# ============================================================================
# 6. Run Application-Specific Bootstraps
# ============================================================================
run_app_bootstraps() {
  # Run the Home/.config/yadm/bootstrap if it exists
  local home_bootstrap="${HOME}/.config/yadm/bootstrap"

  if [[ -x "$home_bootstrap" ]]; then
    info "Running application-specific bootstrap: $home_bootstrap"
    "$home_bootstrap" || warn "Application bootstrap returned non-zero exit code"
  fi
}

# ============================================================================
# Main Execution
# ============================================================================
main() {
  deploy_home_dotfiles
  install_base_deps
  configure_shell
  deploy_system_configs
  setup_alternates
  run_app_bootstraps

  echo ""
  success "✓ YADM Bootstrap completed successfully!"
  echo ""
  info "Next steps:"
  info "  • Log out and back in to use Zsh as your default shell"
  info "  • Run 'yadm status' to check your dotfiles status"
  info "  • Run 'yadm-sync --help' to learn about syncing changes back to repo"
  info "  • System configs require sudo: sudo tuckr link -d $REPO_DIR -t / etc usr"
  echo ""
}

main "$@"
