#!/usr/bin/env bash
# Pre-commit hook to check for bash performance anti-patterns
set -e

# Colors
RED=$'\e[31m'
YELLOW=$'\e[33m'
GREEN=$'\e[32m'
RESET=$'\e[0m'

echo "${GREEN}Running bash performance checks...${RESET}"

# Get list of staged .sh files
staged_scripts=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

if [[ -z $staged_scripts ]]; then
  echo "${GREEN}✓ No shell scripts to check${RESET}"
  exit 0
fi

errors=0
warnings=0

# Check each staged script
for script in $staged_scripts; do
  if [[ ! -f $script ]]; then
    continue
  fi
  
  echo "Checking: $script"
  
  # Check for $(cat ...) patterns
  if grep -q '\$(cat ' "$script"; then
    echo "${YELLOW}⚠ Warning: Found \$(cat ...) pattern in $script${RESET}"
    echo "  Consider using: [[ -f \$file ]] && content=\$(<\"\$file\")"
    ((warnings++))
  fi
  
  # Check for tput calls
  if grep -q 'tput setaf\|tput sgr0' "$script"; then
    echo "${YELLOW}⚠ Warning: Found tput calls in $script${RESET}"
    echo "  Consider using direct ANSI codes: \$'\\e[31m' instead of \$(tput setaf 1)"
    ((warnings++))
  fi
  
  # Check for cat | grep/awk/sed patterns
  if grep -q 'cat .* | \(grep\|awk\|sed\)' "$script"; then
    echo "${YELLOW}⚠ Warning: Found 'cat | command' pattern in $script${RESET}"
    echo "  Consider using: command < file or grep ... file"
    ((warnings++))
  fi
  
  # Check for ls parsing
  if grep -q 'for .* in \$(ls' "$script"; then
    echo "${RED}✗ Error: Found 'for ... in \$(ls ...)' pattern in $script${RESET}"
    echo "  Use glob patterns instead: for file in *.txt; do ..."
    ((errors++))
  fi
  
  # Run shellcheck if available
  if command -v shellcheck &>/dev/null; then
    if ! shellcheck "$script" 2>&1 | grep -q "^$"; then
      # Only show errors and warnings, not info
      if shellcheck -S error "$script" 2>&1 | grep -q "SC"; then
        echo "${RED}✗ ShellCheck found errors in $script${RESET}"
        shellcheck -S error "$script"
        ((errors++))
      elif shellcheck -S warning "$script" 2>&1 | grep -q "SC"; then
        echo "${YELLOW}⚠ ShellCheck found warnings in $script${RESET}"
        ((warnings++))
      fi
    fi
  fi
done

# Summary
echo ""
if ((errors > 0)); then
  echo "${RED}✗ Found $errors error(s) and $warnings warning(s)${RESET}"
  echo "Please fix errors before committing."
  echo "See docs/BASH_PERFORMANCE.md for best practices."
  exit 1
elif ((warnings > 0)); then
  echo "${YELLOW}⚠ Found $warnings warning(s)${RESET}"
  echo "Consider addressing these warnings. See docs/BASH_PERFORMANCE.md"
  echo ""
  read -p "Continue with commit? [y/N] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "${GREEN}✓ All checks passed${RESET}"
exit 0
