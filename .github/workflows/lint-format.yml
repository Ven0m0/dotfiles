name: Lint & Format
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: true
permissions:
  contents: read
env:
  EXCLUDE_DIRS: ".git,node_modules,vendor,.cache,.venv,__pycache__"
jobs:
  lint-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: false
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Linting Tools
        run: |
          set -euo pipefail
          # Go tools
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          go install github.com/google/yamlfmt/cmd/yamlfmt@latest
          # Node tools
          npm install -g @biomejs/biome prettier markdownlint-cli
          # Python tools
          pip install --quiet ruff yamllint mdformat mdformat-gfm
          # Add to PATH
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Check Shell Scripts (shfmt)
        id: shfmt
        run: |
          set -euo pipefail
          echo "## Shell Format Check (2-space indent)" >> "$GITHUB_STEP_SUMMARY"
          ERRORS=0
          while IFS= read -r -d '' file; do
            if ! shfmt -l -d -i 2 -ci -bn "$file" >/dev/null 2>&1; then
              echo "::error file=$file::Shell formatting issues detected"
              echo "- ‚ùå \`$file\` - needs formatting" >> "$GITHUB_STEP_SUMMARY"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find . -type f \( -name "*.sh" -o -name "*.bash" -o -name ".bashrc" \
            -o -name ".bash_*" -o -name ".profile" \) \
            ! -path "./.git/*" ! -path "./vendor/*" -print0)
          if [[ $ERRORS -eq 0 ]]; then
            echo "‚úÖ All shell scripts properly formatted" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::error::$ERRORS shell script(s) need formatting"
            exit 1
          fi
      - name: Check Shell Scripts (shellcheck)
        id: shellcheck
        run: |
          set -euo pipefail
          echo "## ShellCheck Analysis" >> "$GITHUB_STEP_SUMMARY"
          ERRORS=0
          while IFS= read -r -d '' file; do
            # Skip zsh-specific files
            if [[ "$file" == *"zsh"* ]]; then
              continue
            fi
            if head -1 "$file" 2>/dev/null | grep -q "zsh"; then
              continue
            fi
            if ! shellcheck --severity=warning -x "$file" 2>/dev/null; then
              echo "- ‚ö†Ô∏è \`$file\` - shellcheck warnings" >> "$GITHUB_STEP_SUMMARY"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find . -type f \( -name "*.sh" -o -name "*.bash" \) \
            ! -path "./.git/*" ! -path "./vendor/*" -print0)
          if [[ $ERRORS -eq 0 ]]; then
            echo "‚úÖ ShellCheck passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::$ERRORS shell script(s) have shellcheck warnings"
          fi
        continue-on-error: true
      - name: Check JSON/JS/CSS (Biome)
        id: biome
        run: |
          set -euo pipefail
          echo "## Biome Check" >> "$GITHUB_STEP_SUMMARY"
          if biome check . --reporter=summary 2>/dev/null; then
            echo "‚úÖ Biome check passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::error::Biome check failed"
            echo "‚ùå Biome check failed" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
      - name: Check YAML (yamllint)
        id: yamllint
        run: |
          set -euo pipefail
          echo "## YAML Lint" >> "$GITHUB_STEP_SUMMARY"
          CONFIG_ARGS=(-c .yamllint.yaml)
          ERRORS=0
          while IFS= read -r -d '' file; do
            if yamllint "${CONFIG_ARGS[@]}" "$file" 2>/dev/null | grep -q "error"; then
              echo "- ‚ö†Ô∏è \`$file\` - yamllint errors" >> "$GITHUB_STEP_SUMMARY"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find . -type f \( -name "*.yml" -o -name "*.yaml" \) \
            ! -path "./.git/*" ! -path "./vendor/*" -print0)
          if [[ $ERRORS -eq 0 ]]; then
            echo "‚úÖ YAML lint passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::$ERRORS YAML file(s) have errors"
          fi
        continue-on-error: true
      - name: Check GitHub Actions (actionlint)
        id: actionlint
        run: |
          set -euo pipefail
          echo "## GitHub Actions Lint" >> "$GITHUB_STEP_SUMMARY"
          if actionlint .github/workflows/*.yml 2>&1 | tee /tmp/actionlint.txt; then
            echo "‚úÖ Actionlint passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::error::Actionlint found errors"
            echo "‚ùå Actionlint found errors:" >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/actionlint.txt >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
      - name: Check Python (ruff)
        id: ruff
        run: |
          set -euo pipefail
          echo "## Python Lint (Ruff)" >> "$GITHUB_STEP_SUMMARY"
          PY_FILES=$(find . -type f -name "*.py" \
            ! -path "./.git/*" ! -path "./vendor/*" ! -path "./.venv/*")
          if [[ -n "$PY_FILES" ]]; then
            if ruff check . --config pyproject.toml 2>/dev/null; then
              echo "‚úÖ Ruff check passed" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "::warning::Ruff found issues"
              echo "‚ö†Ô∏è Ruff found issues" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "‚ÑπÔ∏è No Python files found" >> "$GITHUB_STEP_SUMMARY"
          fi
        continue-on-error: true
      - name: Check Markdown (markdownlint)
        id: markdownlint
        run: |
          set -euo pipefail
          echo "## Markdown Lint" >> "$GITHUB_STEP_SUMMARY"
          if markdownlint -c .markdownlintrc "**/*.md" \
            --ignore node_modules --ignore vendor 2>/dev/null; then
            echo "‚úÖ Markdownlint passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::Markdownlint found issues"
            echo "‚ö†Ô∏è Markdownlint found issues" >> "$GITHUB_STEP_SUMMARY"
          fi
        continue-on-error: true
      - name: Summary
        if: always()
        run: |
          {
            echo ""
            echo "---"
            echo "### üõ†Ô∏è Fix Commands"
            echo '```bash'
            echo "# Shell scripts (2-space indent)"
            echo "shfmt -w -i 2 -ci -bn <file>"
            echo ""
            echo "# JSON/JS/CSS"
            echo "biome format --write ."
            echo ""
            echo "# YAML"
            echo "yamlfmt -conf .yamlfmt <file>"
            echo ""
            echo "# Python"
            echo "ruff format . && ruff check --fix ."
            echo ""
            echo "# Markdown"
            echo "mdformat --wrap 80 <file>"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Check Results
        if: always()
        run: |
          # Critical checks that must pass
          if [[ "${{ steps.shfmt.outcome }}" == "failure" ]]; then
            echo "::error::Shell formatting check failed"
            exit 1
          fi
          if [[ "${{ steps.biome.outcome }}" == "failure" ]]; then
            echo "::error::Biome check failed"
            exit 1
          fi
          if [[ "${{ steps.actionlint.outcome }}" == "failure" ]]; then
            echo "::error::Actionlint check failed"
            exit 1
          fi
          echo "‚úÖ All critical checks passed"
