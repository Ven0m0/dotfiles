# https://github.com/marketplace/actions/update-git-submodules
name: Submodule update
on:
  workflow_dispatch:
  schedule: [{cron: "0 0 * * 0"}]

jobs:
  update:
    name: "Update Git Submodules"
    runs-on: ubuntu-latest

    # Add permissions for checking out code and creating a pull request
    permissions:
      contents: write
      pull-requests: write

    steps:
      # Step 1: Checkout the repository with its submodules
      - name: "Checkout Repository"
        uses: actions/checkout@v4 # Updated to v4
        with:
          submodules: "recursive"
          # The token is required to push changes and create a PR
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Update all submodules to the latest commit on their tracked branch
      - name: "Update Submodules"
        id: submodules
        uses: sgoudham/update-git-submodules@v2 # Using major version for non-breaking updates

      # Step 3: Create a pull request with the updated submodule references
      - name: "Create Pull Request"
        # This step only runs if the previous step found updates
        if: steps.submodules.outputs.hasChanges == 'true'
        uses: peter-evans/create-pull-request@v6 # Updated to v6
        with:
          # The token is required for this action to work
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(submodules): update submodules to latest commit"
          branch: "chore/update-submodules"
          title: "Update Git Submodules"
          body: ${{ steps.submodules.outputs.prBody }} # Use output from the update step for a detailed body
          # Set the author of the commit to the GitHub Actions bot
          author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
