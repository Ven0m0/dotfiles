name: Submodule Update & Maintenance
on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 0" # Runs every Sunday at 05:00 UTC
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          # Fetch all history for all branches and tags
          fetch-depth: 0
          # Checkout submodules recursively
          submodules: recursive
      - name: Update submodules and run maintenance
        id: update
        run: |
          set -e
          echo "Syncing and updating submodules to remote HEAD..."
          git submodule sync --recursive
          git submodule update --init --recursive --remote --merge --filter=blob:none
          echo "Running git maintenance..."
          git maintenance run --quiet
          # Check if the update resulted in any changes to be committed.
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected."
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to submodules."
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create Pull Request
        # This step only runs if the previous step detected changes.
        if: steps.update.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          # Required for the action to create a PR
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_message: "chore(submodules): Update to latest commits"
          # Create a new branch name for the PR
          branch: "chore/submodule-updates"
          # PR configuration
          create_pull_request: true
          pull_request_title: "Chore: Update Submodules"
          pull_request_body: |
            Automated submodule update.
            
            This PR was generated by the [Submodule Update & Maintenance](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.
